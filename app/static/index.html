<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warehouse Manager</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#f0f2f5;color:#1a1a2e}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.header h1{font-size:20px;font-weight:600}
.header .stats{display:flex;gap:20px;font-size:13px}
.header .stats span{background:rgba(255,255,255,.2);padding:4px 12px;border-radius:20px}
.tabs{display:flex;background:#fff;border-bottom:2px solid #e8e8e8;padding:0 24px;gap:0}
.tab{padding:14px 24px;cursor:pointer;font-weight:500;color:#666;border-bottom:3px solid transparent;transition:.2s}
.tab:hover{color:#667eea}
.tab.active{color:#667eea;border-bottom-color:#667eea}
.content{max-width:1400px;margin:0 auto;padding:20px}
.panel{display:none}
.panel.active{display:block}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap}
.search{padding:10px 16px;border:1px solid #ddd;border-radius:8px;width:300px;font-size:14px;outline:none;transition:.2s}
.search:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#667eea;color:#fff}.btn-primary:hover{background:#5a6fd6}
.btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
.btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
.btn-warning{background:#ffc107;color:#333}.btn-warning:hover{background:#e0a800}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-outline{background:transparent;border:1px solid #667eea;color:#667eea}.btn-outline:hover{background:#667eea;color:#fff}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.08)}
thead{background:#f8f9fa}
th{padding:12px 16px;text-align:left;font-weight:600;font-size:13px;color:#555;border-bottom:2px solid #e8e8e8}
td{padding:12px 16px;border-bottom:1px solid #f0f0f0;font-size:14px}
tr:hover{background:#f8f9ff}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-pending{background:#fff3cd;color:#856404}
.badge-confirmed,.badge-processing{background:#cce5ff;color:#004085}
.badge-packing{background:#e8daef;color:#6c3483}
.badge-packed,.badge-label_purchased{background:#d4edda;color:#155724}
.badge-shipped,.badge-in_transit{background:#d1ecf1;color:#0c5460}
.badge-delivered{background:#28a745;color:#fff}
.badge-cancelled{background:#f8d7da;color:#721c24}
.badge-drop_off{background:#17a2b8;color:#fff}
.badge-draft{background:#e2e3e5;color:#383d41}
.badge-approved{background:#d4edda;color:#155724}
.badge-receiving{background:#cce5ff;color:#004085}
.badge-completed{background:#28a745;color:#fff}
.stock-low{color:#dc3545;font-weight:700}
.stock-ok{color:#28a745;font-weight:600}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:0;width:600px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{padding:20px 24px;border-bottom:1px solid #e8e8e8;display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:18px}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#999;padding:0 4px}
.modal-close:hover{color:#333}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid #e8e8e8;display:flex;justify-content:flex-end;gap:10px}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:13px;color:#555}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.order-items-list{margin:12px 0}
.order-item-row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.order-item-row select,.order-item-row input:not(.oi-search){flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px}
.order-item-row .btn{flex-shrink:0}
.product-search-wrap{position:relative;flex:1;min-width:180px}
.product-search-wrap input{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;outline:none;transition:.2s}
.product-search-wrap input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.product-search-wrap .ps-dropdown{display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:220px;overflow-y:auto;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.12)}
.product-search-wrap.open .ps-dropdown{display:block}
.ps-dropdown .ps-item{padding:8px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
.ps-dropdown .ps-item:hover,.ps-dropdown .ps-item.active{background:#f0f3ff}
.ps-dropdown .ps-item .ps-sku{font-weight:600;color:#333}
.ps-dropdown .ps-item .ps-name{color:#888;font-size:12px;margin-left:8px}
.ps-dropdown .ps-item .ps-qty{font-size:11px;color:#667eea;white-space:nowrap}
.ps-dropdown .ps-empty{padding:12px;text-align:center;color:#999;font-size:13px}
.empty{text-align:center;padding:60px;color:#999;font-size:15px}
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;color:#fff;font-size:14px;z-index:300;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.toast-success{background:#28a745}
.toast-error{background:#dc3545}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-item{padding:8px 0}
.detail-item .label{font-size:12px;color:#888;margin-bottom:2px}
.detail-item .value{font-size:14px;font-weight:500}
.actions-cell{display:flex;gap:6px}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.08);margin-bottom:16px}
.card h3{margin-bottom:12px;font-size:16px;color:#333}
.report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.report-card{background:#fff;border-radius:12px;padding:20px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.report-card .number{font-size:28px;font-weight:700;color:#667eea}
.report-card .label{font-size:13px;color:#888;margin-top:4px}
/* User Management */
.user-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px}
.user-stat-card{background:#fff;border-radius:12px;padding:20px;display:flex;align-items:center;gap:14px;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.user-stat-card .stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.user-stat-card .stat-icon svg{width:22px;height:22px}
.user-stat-card .stat-info .stat-num{font-size:24px;font-weight:700;line-height:1.2}
.user-stat-card .stat-info .stat-label{font-size:12px;color:#888;margin-top:2px}
.um-tab.active{color:#667eea!important;border-bottom-color:#667eea!important}
.um-panel{min-height:200px}
#user-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.user-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.08);transition:.2s;position:relative;border-left:4px solid #667eea}
.user-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.12)}
.user-card.disabled{opacity:.55;border-left-color:#dc3545}
.user-card .uc-top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.user-card .uc-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0;text-transform:uppercase}
.user-card .uc-info{flex:1;min-width:0}
.user-card .uc-name{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-card .uc-username{font-size:12px;color:#888}
.user-card .uc-meta{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.user-card .uc-actions{display:flex;gap:6px;flex-wrap:wrap}
.user-card .uc-self{position:absolute;top:12px;right:12px;font-size:10px;background:#667eea;color:#fff;padding:2px 8px;border-radius:10px}
.role-option{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;padding:14px 10px;border:2px solid #e8e8e8;border-radius:10px;cursor:pointer;transition:.2s;text-align:center}
.role-option:hover{border-color:#667eea;background:#f8f9ff}
.role-option.selected{border-color:#667eea;background:#f0f3ff}
.role-option span{font-weight:600;font-size:14px}
.role-option small{font-size:11px;color:#888}
.action-badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600}
.action-login{background:#d4edda;color:#155724}
.action-create_user,.action-create_order{background:#cce5ff;color:#004085}
.action-update_user,.action-scan{background:#e8daef;color:#6c3483}
.action-toggle_user{background:#fff3cd;color:#856404}
.action-reset_password,.action-change_password{background:#f8d7da;color:#721c24}
.user-dropdown{position:relative;display:inline-block}
.user-dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:150;min-width:180px;padding:6px 0;margin-top:4px}
.user-dropdown-menu.open{display:block}
.user-dropdown-menu a{display:flex;align-items:center;gap:8px;padding:10px 16px;font-size:13px;color:#333;text-decoration:none;transition:.15s}
.user-dropdown-menu a:hover{background:#f0f3ff;color:#667eea}
.user-dropdown-menu hr{border:none;border-top:1px solid #eee;margin:4px 0}
</style>
</head>
<body>

<div class="header">
  <h1>Warehouse Manager</h1>
  <div class="stats">
    <span id="stat-products">0 Products</span>
    <span id="stat-orders">0 Orders</span>
    <span id="stat-low-stock">0 Low Stock</span>
    <div class="user-dropdown">
      <span id="current-user" style="cursor:pointer;background:rgba(255,255,255,.2);padding:4px 12px;border-radius:20px;font-size:13px" onclick="document.getElementById('user-menu').classList.toggle('open')"></span>
      <div class="user-dropdown-menu" id="user-menu">
        <a href="#" onclick="openChangePwModal();document.getElementById('user-menu').classList.remove('open')">
          <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
          Change Password
        </a>
        <hr>
        <a href="#" onclick="doLogout()" style="color:#dc3545">
          <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
          Logout
        </a>
      </div>
    </div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="products">Products</div>
  <div class="tab" data-tab="orders">Orders</div>
  <div class="tab" data-tab="inventory">Inventory</div>
  <div class="tab" data-tab="reports">Reports</div>
  <div class="tab" data-tab="users" id="tab-users" style="display:none">Users</div>
</div>

<div class="content">
  <!-- PRODUCTS PANEL -->
  <div class="panel active" id="panel-products">
    <div class="toolbar">
      <input type="text" class="search" id="search-products" placeholder="Search products...">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="loadProducts()">Refresh</button>
        <a href="/api/v1/products/import-template" class="btn btn-outline btn-sm" download>CSV Template</a>
        <label class="btn btn-success btn-sm" style="margin:0">Import CSV<input type="file" accept=".csv" id="csv-import" style="display:none" onchange="importCSV(this)"></label>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('import-guide-modal').classList.add('show')" title="Import guide">?</button>
        <button class="btn btn-primary" onclick="openProductModal()">+ Add Product</button>
      </div>
    </div>
    <table>
      <thead><tr><th style="width:48px"></th><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Variants</th><th>Stock</th><th>Location</th><th>Actions</th></tr></thead>
      <tbody id="products-body"></tbody>
    </table>
  </div>

  <!-- ORDERS PANEL -->
  <div class="panel" id="panel-orders">
    <div class="toolbar">
      <div style="display:flex;gap:10px;align-items:center">
        <input type="text" class="search" id="search-orders" placeholder="Search orders...">
        <select id="filter-status" style="padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="processing">Processing</option>
          <option value="packed">Packed</option>
          <option value="label_purchased">Label Purchased</option>
          <option value="drop_off">Drop Off</option>
          <option value="shipped">Shipped</option>
          <option value="in_transit">In Transit</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="loadOrders()">Refresh</button>
        <a href="/api/v1/orders/import-template" class="btn btn-outline btn-sm" download>CSV Template</a>
        <label class="btn btn-success btn-sm" style="margin:0">Import Orders<input type="file" accept=".csv" id="csv-import-orders" style="display:none" onchange="importOrderCSV(this)"></label>
        <button class="btn btn-warning btn-sm" id="btn-create-picking" onclick="createPickingList()" style="display:none">Create Picking List (<span id="selected-count">0</span>)</button>
        <a href="/packing" target="_blank" class="btn btn-outline btn-sm">Packing Station</a>
        <button class="btn btn-primary" onclick="openOrderModal()">+ Create Order</button>
      </div>
    </div>
    <table>
      <thead><tr><th style="width:36px"><input type="checkbox" id="select-all-orders" onchange="toggleAllOrders(this)"></th><th>Order #</th><th>Order Name</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Tracking</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>

  <!-- INVENTORY PANEL -->
  <div class="panel" id="panel-inventory">
    <!-- Sub-tabs -->
    <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid #e8e8e8">
      <div class="inv-tab active" data-inv="overview" style="padding:10px 20px;cursor:pointer;font-weight:500;font-size:14px;color:#666;border-bottom:3px solid transparent" onclick="switchInvTab('overview')">Overview</div>
      <div class="inv-tab" data-inv="stock-requests" style="padding:10px 20px;cursor:pointer;font-weight:500;font-size:14px;color:#666;border-bottom:3px solid transparent" onclick="switchInvTab('stock-requests')">Stock Requests</div>
    </div>

    <!-- Inventory Overview -->
    <div id="inv-overview" class="inv-panel">
      <div class="toolbar">
        <input type="text" class="search" id="search-inventory" placeholder="Search by SKU or name...">
        <button class="btn btn-outline btn-sm" onclick="loadInventoryOverview()">Refresh</button>
      </div>
      <table>
        <thead><tr><th>SKU</th><th>Name</th><th>Variant</th><th>Requested</th><th>Received</th><th>Sold</th><th>Adjusted</th><th>Stock</th><th>Location</th></tr></thead>
        <tbody id="inv-overview-body"></tbody>
      </table>
    </div>

    <!-- Stock Requests -->
    <div id="inv-stock-requests" class="inv-panel" style="display:none">
      <div class="toolbar">
        <div style="display:flex;gap:10px;align-items:center">
          <input type="text" class="search" id="search-sr" placeholder="Search requests...">
          <select id="filter-sr-status" style="padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px">
            <option value="">All Statuses</option>
            <option value="draft">Draft</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="receiving">Receiving</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div>
          <button class="btn btn-outline btn-sm" onclick="loadStockRequests()">Refresh</button>
          <button class="btn btn-primary" onclick="openStockRequestModal()">+ New Request</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Request #</th><th>Supplier</th><th>Items</th><th>Total Requested</th><th>Total Received</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="sr-body"></tbody>
      </table>
    </div>
  </div>

  <!-- REPORTS PANEL -->
  <div class="panel" id="panel-reports">
    <div class="report-grid" id="report-cards"></div>
    <div class="card">
      <h3>Top Selling Products</h3>
      <table>
        <thead><tr><th>#</th><th>SKU</th><th>Name</th><th>Sold</th><th>Revenue</th></tr></thead>
        <tbody id="top-products-body"></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Low Stock Products</h3>
      <table>
        <thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Location</th></tr></thead>
        <tbody id="low-stock-body"></tbody>
      </table>
    </div>
  </div>

  <!-- USERS PANEL (admin only) -->
  <div class="panel" id="panel-users">
    <!-- Stats cards -->
    <div class="user-stats-grid" id="user-stats"></div>

    <!-- Sub-tabs: Users / Activity -->
    <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid #e8e8e8">
      <div class="um-tab active" data-um="user-list" style="padding:10px 20px;cursor:pointer;font-weight:500;font-size:14px;color:#666;border-bottom:3px solid transparent" onclick="switchUmTab('user-list')">
        <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        Users
      </div>
      <div class="um-tab" data-um="activity-log" style="padding:10px 20px;cursor:pointer;font-weight:500;font-size:14px;color:#666;border-bottom:3px solid transparent" onclick="switchUmTab('activity-log')">
        <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Activity Log
      </div>
    </div>

    <!-- User List sub-panel -->
    <div id="um-user-list" class="um-panel">
      <div class="toolbar">
        <input type="text" class="search" id="search-users" placeholder="Search users..." oninput="filterUsers()">
        <button class="btn btn-primary" onclick="openCreateUserModal()">+ New User</button>
      </div>
      <div id="user-cards-grid"></div>
    </div>

    <!-- Activity Log sub-panel -->
    <div id="um-activity-log" class="um-panel" style="display:none">
      <div class="toolbar">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="activity-user-filter" onchange="loadActivityLogs()" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px">
            <option value="">All users</option>
          </select>
          <select id="activity-action-filter" onchange="loadActivityLogs()" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px">
            <option value="">All actions</option>
            <option value="login">Login</option>
            <option value="create_user">Create User</option>
            <option value="update_user">Update User</option>
            <option value="toggle_user">Toggle User</option>
            <option value="reset_password">Reset Password</option>
            <option value="change_password">Change Password</option>
            <option value="create_order">Create Order</option>
            <option value="scan">Scan</option>
          </select>
          <select id="activity-limit" onchange="loadActivityLogs()" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px">
            <option value="50">Last 50</option>
            <option value="100" selected>Last 100</option>
            <option value="200">Last 200</option>
          </select>
        </div>
        <button class="btn btn-outline btn-sm" onclick="loadActivityLogs()">Refresh</button>
      </div>
      <table>
        <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Detail</th><th>IP</th></tr></thead>
        <tbody id="activity-log-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- CREATE/EDIT USER MODAL -->
<div class="modal-overlay" id="create-user-modal">
  <div class="modal" style="width:480px">
    <div class="modal-header">
      <h2 id="user-modal-title">
        <svg style="width:20px;height:20px;vertical-align:-4px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        New User
      </h2>
      <button class="modal-close" onclick="closeModal('create-user-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="user-edit-id">
      <div class="form-row">
        <div class="form-group"><label>Username *</label><input type="text" id="u-username" placeholder="e.g. john.doe" autocomplete="off"></div>
        <div class="form-group"><label>Display Name</label><input type="text" id="u-display-name" placeholder="e.g. John Doe"></div>
      </div>
      <div class="form-group" id="u-password-group"><label>Password *</label>
        <div style="position:relative">
          <input type="password" id="u-password" placeholder="Min 4 characters" autocomplete="new-password">
          <span onclick="togglePwVis('u-password',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:#999;font-size:13px;user-select:none">Show</span>
        </div>
      </div>
      <div class="form-group">
        <label>Role</label>
        <div style="display:flex;gap:10px">
          <label class="role-option" id="role-opt-staff" onclick="selectRole('staff')">
            <svg style="width:20px;height:20px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span>Staff</span>
            <small>Basic access: products, orders, packing</small>
          </label>
          <label class="role-option" id="role-opt-admin" onclick="selectRole('admin')">
            <svg style="width:20px;height:20px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span>Admin</span>
            <small>Full access: users, settings, reports</small>
          </label>
        </div>
        <input type="hidden" id="u-role" value="staff">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('create-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveUser()">Save User</button>
    </div>
  </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="modal-overlay" id="reset-pw-modal">
  <div class="modal" style="width:420px">
    <div class="modal-header">
      <h2>
        <svg style="width:20px;height:20px;vertical-align:-4px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        Reset Password
      </h2>
      <button class="modal-close" onclick="closeModal('reset-pw-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#856404">
        This will change the password for <strong id="reset-pw-user"></strong>. They will need to use the new password on next login.
      </div>
      <div class="form-group"><label>New Password *</label>
        <div style="position:relative">
          <input type="password" id="reset-pw-input" placeholder="Enter new password" autocomplete="new-password">
          <span onclick="togglePwVis('reset-pw-input',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:#999;font-size:13px;user-select:none">Show</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('reset-pw-modal')">Cancel</button>
      <button class="btn btn-danger" onclick="doResetPassword()">Reset Password</button>
    </div>
  </div>
</div>

<!-- CHANGE OWN PASSWORD MODAL -->
<div class="modal-overlay" id="change-pw-modal">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <h2>
        <svg style="width:20px;height:20px;vertical-align:-4px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        Change Password
      </h2>
      <button class="modal-close" onclick="closeModal('change-pw-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>New Password *</label>
        <div style="position:relative">
          <input type="password" id="change-pw-input" placeholder="Enter new password" autocomplete="new-password">
          <span onclick="togglePwVis('change-pw-input',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:#999;font-size:13px;user-select:none">Show</span>
        </div>
      </div>
      <div class="form-group"><label>Confirm Password *</label>
        <input type="password" id="change-pw-confirm" placeholder="Confirm new password" autocomplete="new-password">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('change-pw-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="doChangeOwnPassword()">Change Password</button>
    </div>
  </div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="product-modal-title">Add Product</h2>
      <button class="modal-close" onclick="closeModal('product-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="product-edit-id">
      <div class="form-row">
        <div class="form-group"><label>SKU *</label><input type="text" id="p-sku" placeholder="e.g. SKU-001"></div>
        <div class="form-group"><label>Product Name *</label><input type="text" id="p-name" placeholder="Product name"></div>
      </div>
      <div class="form-group"><label>Description</label><textarea id="p-desc" rows="2" placeholder="Product description"></textarea></div>
      <div class="form-group">
        <label>Product Image</label>
        <div id="p-image-preview" style="display:none;margin-bottom:8px;text-align:center">
          <img id="p-image-preview-img" src="" alt="" style="max-width:120px;max-height:120px;border-radius:8px;border:1px solid #ddd;object-fit:cover">
          <div><span style="font-size:12px;color:#dc3545;cursor:pointer" onclick="clearProductImage()">Remove</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="btn btn-outline btn-sm" style="margin:0;cursor:pointer">Upload File<input type="file" accept="image/*" id="p-image-file" style="display:none" onchange="onProductFileSelected(this)"></label>
          <span style="font-size:13px;color:#888">or</span>
          <input type="url" id="p-image-url" placeholder="https://example.com/image.jpg" style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px">
        </div>
        <div id="p-image-upload-status" style="display:none;font-size:12px;color:#667eea;margin-top:4px">Uploading...</div>
      </div>
      <div class="form-row-3">
        <div class="form-group"><label>Category</label><input type="text" id="p-category" placeholder="e.g. Electronics"></div>
        <div class="form-group"><label>Price (USD)</label><input type="number" step="0.01" id="p-price" placeholder="0.00"></div>
        <div class="form-group"><label>Weight (oz)</label><input type="number" step="0.1" id="p-weight" placeholder="0"></div>
      </div>
      <div style="margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:8px">
        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;color:#555">Package Dimensions (inches)</label>
        <div class="form-row-3">
          <div class="form-group" style="margin:0"><label>Length (L)</label><input type="number" step="0.1" id="p-length" placeholder="0"></div>
          <div class="form-group" style="margin:0"><label>Width (W)</label><input type="number" step="0.1" id="p-width" placeholder="0"></div>
          <div class="form-group" style="margin:0"><label>Height (H)</label><input type="number" step="0.1" id="p-height" placeholder="0"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Quantity</label><input type="number" id="p-qty" placeholder="0"></div>
        <div class="form-group"><label>Warehouse Location</label><input type="text" id="p-location" placeholder="e.g. A-01-03"></div>
      </div>
      <div class="form-group">
        <label>Variant Option Types (comma separated)</label>
        <input type="text" id="p-option-types" placeholder="e.g. color, size">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('product-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProduct()">Save</button>
    </div>
  </div>
</div>

<!-- ORDER MODAL -->
<div class="modal-overlay" id="order-modal">
  <div class="modal" style="width:700px">
    <div class="modal-header">
      <h2>Create New Order</h2>
      <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Order Name</label><input type="text" id="o-order-name" placeholder="e.g. Order #1, Shopee Feb 2025..."></div>
      <div class="form-row">
        <div class="form-group"><label>Customer Name *</label><input type="text" id="o-name" placeholder="John Smith"></div>
        <div class="form-group"><label>Email</label><input type="email" id="o-email" placeholder="email@example.com"></div>
      </div>
      <div class="form-group"><label>Phone</label><input type="text" id="o-phone" placeholder="555-1234"></div>

      <h3 style="margin:16px 0 8px;font-size:15px">Shipping Address</h3>
      <div class="form-group"><label>Recipient Name *</label><input type="text" id="o-ship-name" placeholder="John Smith"></div>
      <div class="form-group"><label>Address Line 1 *</label><input type="text" id="o-street1" placeholder="123 Main St"></div>
      <div class="form-group"><label>Address Line 2</label><input type="text" id="o-street2" placeholder="Apt 4B"></div>
      <div class="form-row-3">
        <div class="form-group"><label>City *</label><input type="text" id="o-city" placeholder="New York"></div>
        <div class="form-group"><label>State *</label><input type="text" id="o-state" placeholder="NY"></div>
        <div class="form-group"><label>Zip *</label><input type="text" id="o-zip" placeholder="10001"></div>
      </div>

      <h3 style="margin:16px 0 8px;font-size:15px">Shipping</h3>
      <div class="form-row">
        <div class="form-group"><label>Carrier</label>
          <select id="o-carrier" onchange="updateServiceOptions('o-carrier','o-service')">
            <option value="USPS">USPS</option><option value="UPS">UPS</option><option value="FedEx">FedEx</option>
          </select>
        </div>
        <div class="form-group"><label>Service</label>
          <select id="o-service"></select>
        </div>
      </div>

      <h3 style="margin:16px 0 8px;font-size:15px">Products</h3>
      <div class="order-items-list" id="order-items-list"></div>
      <button class="btn btn-outline btn-sm" onclick="addOrderItemRow()">+ Add Product</button>

      <div class="form-group" style="margin-top:16px"><label>Notes</label><textarea id="o-notes" rows="2" placeholder="Notes"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('order-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveOrder()">Create Order</button>
    </div>
  </div>
</div>

<!-- ORDER DETAIL MODAL -->
<div class="modal-overlay" id="order-detail-modal">
  <div class="modal" style="width:700px">
    <div class="modal-header">
      <h2 id="order-detail-title">Order Details</h2>
      <button class="modal-close" onclick="closeModal('order-detail-modal')">&times;</button>
    </div>
    <div class="modal-body" id="order-detail-body"></div>
    <div class="modal-footer" id="order-detail-footer"></div>
  </div>
</div>

<!-- INVENTORY MODAL -->
<div class="modal-overlay" id="inventory-modal">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <h2>Adjust Inventory</h2>
      <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="inv-product-id">
      <div class="form-group"><label>Quantity (+ to add / - to remove)</label><input type="number" id="inv-qty" placeholder="e.g. 10 or -5"></div>
      <div class="form-group"><label>Reason</label><input type="text" id="inv-reason" placeholder="e.g. restock"></div>
      <div class="form-group"><label>Note</label><input type="text" id="inv-note" placeholder="Details"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('inventory-modal')">Cancel</button>
      <button class="btn btn-success" onclick="saveInventory()">Update</button>
    </div>
  </div>
</div>

<!-- VARIANTS MODAL -->
<div class="modal-overlay" id="variants-modal">
  <div class="modal" style="width:800px">
    <div class="modal-header">
      <h2 id="variants-modal-title">Variants</h2>
      <button class="modal-close" onclick="closeModal('variants-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div id="variants-product-info" style="margin-bottom:12px;font-size:13px;color:#888"></div>
      <div style="margin-bottom:12px">
        <strong style="font-size:13px">Option types:</strong>
        <span id="variants-option-types" style="font-size:13px;color:#667eea"></span>
      </div>
      <table>
        <thead><tr><th>Variant SKU</th><th>Attributes</th><th>Price</th><th>Wt (oz)</th><th>Dims (LxWxH)</th><th>Stock</th><th>Location</th><th>Actions</th></tr></thead>
        <tbody id="variants-body"></tbody>
      </table>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e8e8e8">
        <h3 style="font-size:14px;margin-bottom:10px">Add New Variant</h3>
        <input type="hidden" id="v-product-id">
        <div class="form-row">
          <div class="form-group"><label>Variant SKU *</label><input type="text" id="v-sku" placeholder="e.g. SKU-001-RED-M"></div>
          <div class="form-group"><label>Price (0 = use parent)</label><input type="number" step="0.01" id="v-price" placeholder="0"></div>
        </div>
        <div id="v-attrs-container"></div>
        <div class="form-row">
          <div class="form-group"><label>Weight (oz, 0 = use parent)</label><input type="number" step="0.1" id="v-weight" placeholder="0"></div>
          <div class="form-group"><label>Location</label><input type="text" id="v-location" placeholder="Leave empty = use parent"></div>
        </div>
        <div style="margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:8px">
          <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;color:#555">Dimensions (inches, 0 = use parent)</label>
          <div class="form-row-3">
            <div class="form-group" style="margin:0"><label>Length (L)</label><input type="number" step="0.1" id="v-length" placeholder="0"></div>
            <div class="form-group" style="margin:0"><label>Width (W)</label><input type="number" step="0.1" id="v-width" placeholder="0"></div>
            <div class="form-group" style="margin:0"><label>Height (H)</label><input type="number" step="0.1" id="v-height" placeholder="0"></div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Quantity</label><input type="number" id="v-qty" value="0"></div>
        </div>
        <button class="btn btn-success btn-sm" onclick="saveVariant()">Add Variant</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT GUIDE MODAL -->
<div class="modal-overlay" id="import-guide-modal">
  <div class="modal" style="width:820px">
    <div class="modal-header">
      <h2>CSV Import Guide</h2>
      <button class="modal-close" onclick="closeModal('import-guide-modal')">&times;</button>
    </div>
    <div class="modal-body" style="font-size:13px;line-height:1.7">
      <p><strong>CSV Columns:</strong></p>
      <table style="font-size:12px;margin-bottom:16px">
        <thead>
          <tr><th>Column</th><th>Required</th><th>Description</th></tr>
        </thead>
        <tbody>
          <tr><td><code>sku</code></td><td>Yes</td><td>Product SKU. Variant rows also need this (points to parent product)</td></tr>
          <tr><td><code>name</code></td><td>Product: Yes</td><td>Product name (only needed on product row, leave empty on variant rows)</td></tr>
          <tr><td><code>description</code></td><td>No</td><td>Product description</td></tr>
          <tr><td><code>category</code></td><td>No</td><td>Category</td></tr>
          <tr><td><code>weight_oz</code></td><td>No</td><td>Weight (oz) of parent product</td></tr>
          <tr><td><code>length_in</code>, <code>width_in</code>, <code>height_in</code></td><td>No</td><td>Dimensions (inches) of parent product</td></tr>
          <tr><td><code>price</code></td><td>No</td><td>Parent product price</td></tr>
          <tr><td><code>quantity</code></td><td>No</td><td>Stock quantity (product or variant)</td></tr>
          <tr><td><code>location</code></td><td>No</td><td>Warehouse location</td></tr>
          <tr style="background:#f0f4ff"><td><code>variant_sku</code></td><td>Variant: Yes</td><td>Variant SKU. <b>If present = variant row</b>, if empty = product row</td></tr>
          <tr style="background:#f0f4ff"><td><code>attributes</code></td><td>No</td><td>JSON attributes, e.g. <code>{"color":"Red","size":"M"}</code></td></tr>
          <tr style="background:#f0f4ff"><td><code>price_override</code></td><td>No</td><td>Variant-specific price (0 = use parent price)</td></tr>
          <tr style="background:#f0f4ff"><td><code>weight_oz_override</code></td><td>No</td><td>Variant-specific weight (0 = use parent)</td></tr>
          <tr style="background:#f0f4ff"><td><code>length_in_override</code>, <code>width_in_override</code>, <code>height_in_override</code></td><td>No</td><td>Variant-specific dimensions (0 = use parent)</td></tr>
        </tbody>
      </table>
      <p><strong>Rules:</strong></p>
      <ul style="padding-left:20px;margin-bottom:16px">
        <li>Rows <b>without</b> <code>variant_sku</code> = <b>product</b>. Duplicate SKU will update the product.</li>
        <li>Rows <b>with</b> <code>variant_sku</code> = <b>variant</b>. The <code>sku</code> column points to parent product (must exist first).</li>
        <li>Existing <code>variant_sku</code> will be updated. New ones will be created.</li>
        <li>Override fields set to <b>0</b> will use the parent product values.</li>
      </ul>
      <p><strong>Example:</strong></p>
      <div style="overflow-x:auto;background:#f8f9fa;padding:10px;border-radius:6px;font-family:monospace;font-size:11px;white-space:pre;margin-bottom:8px">sku,name,...,variant_sku,attributes,price_override,...
SP-002,T-Shirt,...,,,,...             &larr; Product row
SP-002,,,,...,SP-002-RED-M,"{""color"":""Red""}",51.99,...  &larr; Variant
SP-002,,,,...,SP-002-BLUE-M,"{""color"":""Blue""}",0,...   &larr; Variant (parent price)</div>
      <p>Click <b>"CSV Template"</b> to download a complete sample file.</p>
    </div>
  </div>
</div>

<!-- STOCK REQUEST CREATE MODAL -->
<div class="modal-overlay" id="sr-create-modal">
  <div class="modal" style="width:700px">
    <div class="modal-header">
      <h2>Create Stock Request</h2>
      <button class="modal-close" onclick="closeModal('sr-create-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Supplier</label><input type="text" id="sr-supplier" placeholder="Supplier name"></div>
        <div class="form-group"><label>Notes</label><input type="text" id="sr-notes" placeholder="Notes"></div>
      </div>
      <h3 style="margin:12px 0 8px;font-size:15px">Products</h3>
      <div class="order-items-list" id="sr-items-list"></div>
      <button class="btn btn-outline btn-sm" onclick="addSrItemRow()">+ Add Product</button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('sr-create-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveStockRequest()">Create</button>
    </div>
  </div>
</div>

<!-- STOCK REQUEST DETAIL MODAL -->
<div class="modal-overlay" id="sr-detail-modal">
  <div class="modal" style="width:800px">
    <div class="modal-header">
      <h2 id="sr-detail-title">Stock Request Details</h2>
      <button class="modal-close" onclick="closeModal('sr-detail-modal')">&times;</button>
    </div>
    <div class="modal-body" id="sr-detail-body"></div>
    <div class="modal-footer" id="sr-detail-footer"></div>
  </div>
</div>

<!-- QR CODE MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal" style="width:900px">
    <div class="modal-header">
      <h2 id="qr-modal-title">QR Codes</h2>
      <button class="modal-close" onclick="closeModal('qr-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" id="qr-print-btn" onclick="printQrPage()">Print All QR</button>
        <button class="btn btn-outline btn-sm" id="qr-bulk-btn">Download Print Sheet (PNG)</button>
      </div>
      <div id="qr-body" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center"></div>
    </div>
  </div>
</div>

<script>
const API = '/api/v1';
let allProducts = [];
let allOrders = [];

// Shipping carriers & services (EasyPost service names)
const CARRIERS = {
  'USPS': ['GroundAdvantage', 'Priority', 'Express', 'ParcelSelect', 'LibraryMail', 'MediaMail', 'First'],
  'UPS': ['Ground', '3DaySelect', '2ndDayAir', '2ndDayAirAM', 'NextDayAirSaver', 'NextDayAir', 'NextDayAirEarlyAM'],
  'FedEx': ['GROUND_HOME_DELIVERY', 'FEDEX_GROUND', 'FEDEX_EXPRESS_SAVER', 'FEDEX_2_DAY', 'STANDARD_OVERNIGHT', 'PRIORITY_OVERNIGHT', 'FIRST_OVERNIGHT'],
};
let defaultCarrier = 'USPS';
let defaultService = 'GroundAdvantage';

let warehouseConfigured = false;

// Load config defaults
fetch(API + '/shipping/defaults').then(r => r.ok ? r.json() : null).then(d => {
  if (d) {
    defaultCarrier = d.carrier; defaultService = d.service;
    if (d.warehouse && d.warehouse.street1) warehouseConfigured = true;
  }
}).catch(() => {});

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    if (tab.dataset.tab === 'reports') loadReports();
    if (tab.dataset.tab === 'inventory') { loadInventoryOverview(); loadStockRequests(); }
    if (tab.dataset.tab === 'users') { loadUsers(); loadActivityLogs(); }
  });
});

// Toast
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Modal
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// PRODUCTS
async function loadProducts() {
  const res = await fetch(API + '/products');
  allProducts = await res.json();
  renderProducts(allProducts);
  document.getElementById('stat-products').textContent = allProducts.length + ' Products';
  const low = allProducts.filter(p => p.quantity <= 5).length;
  document.getElementById('stat-low-stock').textContent = low + ' Low Stock';
}

function renderProducts(list) {
  const q = document.getElementById('search-products').value.toLowerCase();
  const filtered = list.filter(p => !q || p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q));
  document.getElementById('products-body').innerHTML = filtered.length === 0
    ? '<tr><td colspan="9" class="empty">No products found</td></tr>'
    : filtered.map(p => {
        const vc = p.variants ? p.variants.length : 0;
        const totalQty = vc > 0 ? p.variants.reduce((s,v) => s + v.quantity, 0) : p.quantity;
        const variantInfo = vc > 0 ? `${vc} variants` : '-';
        const imgThumb = p.image_url ? `<img src="${esc(p.image_url)}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:6px;border:1px solid #e8e8e8">` : '<div style="width:36px;height:36px;background:#f0f2f5;border-radius:6px;border:1px solid #e8e8e8"></div>';
        return `<tr>
        <td>${imgThumb}</td>
        <td><strong>${esc(p.sku)}</strong></td>
        <td>${esc(p.name)}</td>
        <td>${esc(p.category)}</td>
        <td>$${p.price.toFixed(2)}</td>
        <td>${variantInfo}</td>
        <td class="${totalQty <= 5 ? 'stock-low' : 'stock-ok'}">${totalQty}</td>
        <td>${esc(p.location)}</td>
        <td class="actions-cell">
          <button class="btn btn-sm btn-outline" onclick="editProduct('${p.id}')">Edit</button>
          <button class="btn btn-sm btn-primary" onclick="openVariantsModal('${p.id}')">Variants</button>
          <button class="btn btn-sm btn-warning" onclick="openInventoryModal('${p.id}')">Stock</button>
          ${p.qr_code_path
            ? `<button class="btn btn-sm btn-success" onclick="openQrModal('${p.id}')">QR</button>`
            : `<button class="btn btn-sm btn-danger" onclick="generateQr('${p.id}')">Gen QR</button>`}
        </td>
      </tr>`;}).join('');
}

document.getElementById('search-products').addEventListener('input', () => renderProducts(allProducts));

function openProductModal(product = null) {
  document.getElementById('product-modal-title').textContent = product ? 'Edit Product' : 'Add Product';
  document.getElementById('product-edit-id').value = product ? product.id : '';
  document.getElementById('p-sku').value = product ? product.sku : '';
  document.getElementById('p-sku').disabled = !!product;
  document.getElementById('p-name').value = product ? product.name : '';
  document.getElementById('p-desc').value = product ? product.description : '';
  document.getElementById('p-category').value = product ? product.category : '';
  document.getElementById('p-price').value = product ? product.price : '';
  document.getElementById('p-weight').value = product ? product.weight_oz : '';
  document.getElementById('p-length').value = product ? product.length_in : '';
  document.getElementById('p-width').value = product ? product.width_in : '';
  document.getElementById('p-height').value = product ? product.height_in : '';
  document.getElementById('p-qty').value = product ? product.quantity : '';
  document.getElementById('p-location').value = product ? product.location : '';
  document.getElementById('p-image-url').value = product ? (product.image_url || '') : '';
  document.getElementById('p-image-file').value = '';
  document.getElementById('p-image-upload-status').style.display = 'none';
  // Show image preview if exists
  const imgUrl = product && product.image_url ? product.image_url : '';
  if (imgUrl) {
    document.getElementById('p-image-preview').style.display = '';
    document.getElementById('p-image-preview-img').src = imgUrl;
  } else {
    document.getElementById('p-image-preview').style.display = 'none';
  }
  document.getElementById('p-option-types').value = product && product.option_types ? product.option_types.join(', ') : '';
  if (product) { document.getElementById('p-qty').disabled = true; }
  else { document.getElementById('p-qty').disabled = false; }
  document.getElementById('product-modal').classList.add('show');
}

function editProduct(id) {
  const p = allProducts.find(x => x.id === id);
  if (p) openProductModal(p);
}

// Pending file for upload after product creation
let pendingImageFile = null;

function onProductFileSelected(input) {
  const file = input.files[0];
  if (!file) return;
  const editId = document.getElementById('product-edit-id').value;
  if (editId) {
    // Existing product: upload immediately
    uploadProductImage(editId, file);
  } else {
    // New product: store file, show preview, upload after create
    pendingImageFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById('p-image-preview').style.display = '';
      document.getElementById('p-image-preview-img').src = e.target.result;
      document.getElementById('p-image-url').value = '';
    };
    reader.readAsDataURL(file);
  }
}

async function uploadProductImage(productId, file) {
  const status = document.getElementById('p-image-upload-status');
  status.style.display = '';
  status.textContent = 'Uploading...';
  const formData = new FormData();
  formData.append('file', file);
  try {
    const res = await fetch(API + '/products/' + productId + '/upload-image', { method: 'POST', body: formData });
    if (res.ok) {
      const product = await res.json();
      document.getElementById('p-image-url').value = product.image_url;
      document.getElementById('p-image-preview').style.display = '';
      document.getElementById('p-image-preview-img').src = product.image_url;
      status.textContent = 'Uploaded!';
      setTimeout(() => { status.style.display = 'none'; }, 2000);
      toast('Image uploaded');
      loadProducts();
    } else {
      const e = await res.json();
      toast(e.detail || 'Upload error', 'error');
      status.style.display = 'none';
    }
  } catch (err) {
    toast('Upload failed: ' + err.message, 'error');
    status.style.display = 'none';
  }
}

function clearProductImage() {
  document.getElementById('p-image-url').value = '';
  document.getElementById('p-image-preview').style.display = 'none';
  document.getElementById('p-image-file').value = '';
  pendingImageFile = null;
}

async function saveProduct() {
  const editId = document.getElementById('product-edit-id').value;
  const optTypesRaw = document.getElementById('p-option-types').value;
  const optTypes = optTypesRaw ? optTypesRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
  if (editId) {
    const body = {
      name: document.getElementById('p-name').value,
      description: document.getElementById('p-desc').value,
      category: document.getElementById('p-category').value,
      price: parseFloat(document.getElementById('p-price').value) || 0,
      weight_oz: parseFloat(document.getElementById('p-weight').value) || 0,
      length_in: parseFloat(document.getElementById('p-length').value) || 0,
      width_in: parseFloat(document.getElementById('p-width').value) || 0,
      height_in: parseFloat(document.getElementById('p-height').value) || 0,
      location: document.getElementById('p-location').value,
      image_url: document.getElementById('p-image-url').value,
      option_types: optTypes,
    };
    const res = await fetch(API + '/products/' + editId, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if (res.ok) { toast('Product updated'); closeModal('product-modal'); loadProducts(); }
    else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
  } else {
    const body = {
      sku: document.getElementById('p-sku').value,
      name: document.getElementById('p-name').value,
      description: document.getElementById('p-desc').value,
      category: document.getElementById('p-category').value,
      price: parseFloat(document.getElementById('p-price').value) || 0,
      weight_oz: parseFloat(document.getElementById('p-weight').value) || 0,
      length_in: parseFloat(document.getElementById('p-length').value) || 0,
      width_in: parseFloat(document.getElementById('p-width').value) || 0,
      height_in: parseFloat(document.getElementById('p-height').value) || 0,
      quantity: parseInt(document.getElementById('p-qty').value) || 0,
      location: document.getElementById('p-location').value,
      image_url: document.getElementById('p-image-url').value,
      option_types: optTypes,
    };
    const res = await fetch(API + '/products', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if (res.ok) {
      const newProduct = await res.json();
      // Upload pending file if any
      if (pendingImageFile) {
        await uploadProductImage(newProduct.id, pendingImageFile);
        pendingImageFile = null;
      }
      toast('Product created'); closeModal('product-modal'); loadProducts();
    }
    else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
  }
}

// CSV IMPORT
async function importCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);
  const res = await fetch(API + '/products/import', { method: 'POST', body: formData });
  const result = await res.json();
  if (res.ok) {
    let msg = `Import: ${result.created} new, ${result.updated} updated`;
    if (result.variants_created || result.variants_updated) msg += `, ${result.variants_created || 0} variants new, ${result.variants_updated || 0} variants updated`;
    if (result.errors.length > 0) msg += `, ${result.errors.length} errors`;
    toast(msg);
    loadProducts();
  } else {
    toast(result.detail || 'Import error', 'error');
  }
  input.value = '';
}

async function importOrderCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);
  try {
    const res = await fetch(API + '/orders/import', { method: 'POST', body: formData });
    if (!res.ok) {
      let errMsg;
      try { const e = await res.json(); errMsg = e.detail; } catch { errMsg = await res.text(); }
      toast((errMsg || 'Order import error').slice(0,200), 'error');
      input.value = '';
      return;
    }
    const result = await res.json();
    let msg = `Import: ${result.created} orders created`;
    if (result.errors && result.errors.length > 0) msg += `, ${result.errors.length} errors`;
    toast(msg);
    if (result.created_details && result.created_details.length > 0) {
      console.log('Import details:', result.created_details);
      result.created_details.forEach(d => {
        const items = d.items.map(i => `${i.item_name} x${i.quantity}`).join(', ');
        console.log(`  ${d.order_name}: ${items}`);
      });
    }
    if (result.errors && result.errors.length > 0) {
      console.log('Import errors:', result.errors);
      toast('Check Console (F12) for error details', 'error');
    }
    loadOrders();
  } catch(e) { toast('Connection error: ' + e.message, 'error'); }
  input.value = '';
}

// VARIANTS
let currentVariantsProductId = '';

function openVariantsModal(productId) {
  currentVariantsProductId = productId;
  document.getElementById('v-product-id').value = productId;
  const p = allProducts.find(x => x.id === productId);
  if (!p) return;
  document.getElementById('variants-modal-title').textContent = 'Variants - ' + p.name;
  document.getElementById('variants-product-info').textContent = `SKU: ${p.sku} | Price: $${p.price.toFixed(2)} | ${p.weight_oz}oz | ${p.length_in}x${p.width_in}x${p.height_in} in`;
  const optTypes = p.option_types || [];
  document.getElementById('variants-option-types').textContent = optTypes.length > 0 ? optTypes.join(', ') : 'Not set';
  renderVariantAttrInputs(optTypes);
  renderVariantsTable(p.variants || []);
  document.getElementById('v-sku').value = '';
  document.getElementById('v-price').value = '';
  document.getElementById('v-weight').value = '';
  document.getElementById('v-length').value = '';
  document.getElementById('v-width').value = '';
  document.getElementById('v-height').value = '';
  document.getElementById('v-qty').value = '0';
  document.getElementById('v-location').value = '';
  document.getElementById('variants-modal').classList.add('show');
}

function renderVariantAttrInputs(optTypes) {
  const container = document.getElementById('v-attrs-container');
  if (optTypes.length === 0) {
    container.innerHTML = '<div class="form-group"><label>Attributes (JSON)</label><input type="text" id="v-attrs-json" placeholder=\'{"color":"Red","size":"M"}\'></div>';
  } else {
    container.innerHTML = '<div class="form-row" style="margin-bottom:12px">' + optTypes.map(t =>
      `<div class="form-group" style="margin:0"><label>${esc(t)}</label><input type="text" class="v-attr-input" data-key="${esc(t)}" placeholder="${esc(t)}"></div>`
    ).join('') + '</div>';
  }
}

function getVariantAttrs() {
  const jsonInput = document.getElementById('v-attrs-json');
  if (jsonInput) {
    try { return JSON.parse(jsonInput.value || '{}'); } catch { return {}; }
  }
  const attrs = {};
  document.querySelectorAll('.v-attr-input').forEach(inp => {
    if (inp.value.trim()) attrs[inp.dataset.key] = inp.value.trim();
  });
  return attrs;
}

function renderVariantsTable(variants) {
  document.getElementById('variants-body').innerHTML = variants.length === 0
    ? '<tr><td colspan="8" class="empty">No variants yet</td></tr>'
    : variants.map(v => {
        const attrs = typeof v.attributes === 'string' ? JSON.parse(v.attributes) : (v.attributes || {});
        const attrStr = Object.entries(attrs).map(([k,val]) => `${k}: ${val}`).join(', ');
        const wt = v.weight_oz_override > 0 ? v.weight_oz_override + ' oz' : 'Parent';
        const dims = (v.length_in_override > 0 || v.width_in_override > 0 || v.height_in_override > 0)
          ? `${v.length_in_override}x${v.width_in_override}x${v.height_in_override}` : 'Parent';
        return `<tr>
          <td><strong>${esc(v.variant_sku)}</strong></td>
          <td>${esc(attrStr)}</td>
          <td>${v.price_override > 0 ? '$'+v.price_override.toFixed(2) : 'Parent'}</td>
          <td>${wt}</td>
          <td>${dims}</td>
          <td class="${v.quantity <= 5 ? 'stock-low' : 'stock-ok'}">${v.quantity}</td>
          <td>${esc(v.location)}</td>
          <td class="actions-cell">
            <button class="btn btn-sm btn-warning" onclick="adjustVariantStock('${v.id}')">Stock</button>
            <button class="btn btn-sm btn-danger" onclick="deleteVariant('${v.id}')">Delete</button>
          </td>
        </tr>`;
      }).join('');
}

async function saveVariant() {
  const productId = document.getElementById('v-product-id').value;
  const body = {
    variant_sku: document.getElementById('v-sku').value,
    attributes: getVariantAttrs(),
    price_override: parseFloat(document.getElementById('v-price').value) || 0,
    weight_oz_override: parseFloat(document.getElementById('v-weight').value) || 0,
    length_in_override: parseFloat(document.getElementById('v-length').value) || 0,
    width_in_override: parseFloat(document.getElementById('v-width').value) || 0,
    height_in_override: parseFloat(document.getElementById('v-height').value) || 0,
    quantity: parseInt(document.getElementById('v-qty').value) || 0,
    location: document.getElementById('v-location').value,
  };
  const res = await fetch(API + '/products/' + productId + '/variants', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res.ok) { toast('Variant added'); await loadProducts(); openVariantsModal(productId); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function deleteVariant(variantId) {
  if (!confirm('Delete this variant?')) return;
  const res = await fetch(API + '/products/variants/' + variantId, { method: 'DELETE' });
  if (res.ok) { toast('Variant deleted'); await loadProducts(); openVariantsModal(currentVariantsProductId); }
  else { toast('Error deleting variant', 'error'); }
}

async function adjustVariantStock(variantId) {
  const qty = prompt('Enter quantity (+ to add, - to remove):');
  if (qty === null) return;
  const res = await fetch(API + '/products/variants/' + variantId + '/inventory', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ quantity: parseInt(qty) || 0, reason: 'adjustment', note: 'Manual adjustment' }),
  });
  if (res.ok) { toast('Variant stock updated'); await loadProducts(); openVariantsModal(currentVariantsProductId); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

// QR CODES
async function generateQr(productId) {
  const res = await fetch(API + '/products/' + productId + '/generate-qr', { method: 'POST' });
  if (res.ok) {
    toast('QR code generated');
    await loadProducts();
    openQrModal(productId);
  } else {
    const e = await res.json();
    toast(e.detail || 'Error generating QR', 'error');
  }
}

function openQrModal(productId) {
  const p = allProducts.find(x => x.id === productId);
  if (!p) return;
  document.getElementById('qr-modal-title').textContent = 'QR Codes - ' + p.name;

  // Bulk download button
  document.getElementById('qr-bulk-btn').onclick = () => {
    window.open(API + '/products/' + productId + '/qrcode/bulk', '_blank');
  };

  // Build QR cards: product + variants
  let html = '';
  // Product QR
  html += `<div style="text-align:center;border:1px solid #e8e8e8;border-radius:12px;padding:12px;background:#fafafa">
    <img src="${API}/products/${p.id}/qrcode" alt="QR ${esc(p.sku)}" style="max-width:280px;border-radius:8px">
    <div style="margin-top:8px;font-size:12px;color:#888">Parent product</div>
    <a href="${API}/products/${p.id}/qrcode" download="${p.sku}.png" class="btn btn-outline btn-sm" style="margin-top:6px">Download</a>
  </div>`;

  // Variant QRs
  if (p.variants && p.variants.length > 0) {
    for (const v of p.variants) {
      const attrs = typeof v.attributes === 'string' ? JSON.parse(v.attributes) : (v.attributes || {});
      const attrStr = Object.values(attrs).join(' / ') || v.variant_sku;
      html += `<div style="text-align:center;border:1px solid #e8e8e8;border-radius:12px;padding:12px;background:#fafafa">
        <img src="${API}/products/variants/${v.id}/qrcode" alt="QR ${esc(v.variant_sku)}" style="max-width:280px;border-radius:8px">
        <div style="margin-top:8px;font-size:12px;color:#888">${esc(attrStr)}</div>
        <a href="${API}/products/variants/${v.id}/qrcode" download="${v.variant_sku}.png" class="btn btn-outline btn-sm" style="margin-top:6px">Download</a>
      </div>`;
    }
  }

  document.getElementById('qr-body').innerHTML = html;
  document.getElementById('qr-modal').classList.add('show');
}

function printQrPage() {
  const content = document.getElementById('qr-body').innerHTML;
  const win = window.open('', '_blank');
  win.document.write(`<html><head><title>Print QR Codes</title><style>
    body{font-family:sans-serif;padding:20px;display:flex;flex-wrap:wrap;gap:16px;justify-content:center}
    div{text-align:center;border:1px solid #ccc;border-radius:8px;padding:12px;page-break-inside:avoid}
    img{max-width:280px}
    .btn{display:none}
    @media print{body{padding:0;gap:8px} div{border:1px solid #ddd;padding:8px}}
  </style></head><body>${content}</body></html>`);
  win.document.close();
  win.onload = () => { win.print(); };
}

// INVENTORY
function openInventoryModal(productId) {
  document.getElementById('inv-product-id').value = productId;
  document.getElementById('inv-qty').value = '';
  document.getElementById('inv-reason').value = '';
  document.getElementById('inv-note').value = '';
  document.getElementById('inventory-modal').classList.add('show');
}

async function saveInventory() {
  const id = document.getElementById('inv-product-id').value;
  const body = {
    quantity: parseInt(document.getElementById('inv-qty').value) || 0,
    reason: document.getElementById('inv-reason').value || 'adjustment',
    note: document.getElementById('inv-note').value,
  };
  const res = await fetch(API + '/products/' + id + '/inventory', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res.ok) { toast('Inventory updated'); closeModal('inventory-modal'); loadProducts(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

// ORDERS
async function loadOrders() {
  const status = document.getElementById('filter-status').value;
  const url = status ? API + '/orders?status=' + status : API + '/orders';
  try {
    const res = await fetch(url);
    if (!res.ok) { const txt = await res.text(); toast(txt.slice(0,100) || 'Error loading orders', 'error'); return; }
    allOrders = await res.json();
    renderOrders(allOrders);
    document.getElementById('stat-orders').textContent = allOrders.length + ' Orders';
  } catch(e) { toast('Server connection error: ' + e.message, 'error'); }
}

function renderOrders(list) {
  const q = document.getElementById('search-orders').value.toLowerCase();
  const filtered = list.filter(o => !q || o.order_number.toLowerCase().includes(q) || o.customer_name.toLowerCase().includes(q) || (o.order_name || '').toLowerCase().includes(q));
  document.getElementById('orders-body').innerHTML = filtered.length === 0
    ? '<tr><td colspan="10" class="empty">No orders found</td></tr>'
    : filtered.map(o => `<tr>
        <td><input type="checkbox" class="order-check" value="${o.id}" onchange="updateSelectedCount()"></td>
        <td><strong>${esc(o.order_number)}</strong></td>
        <td>${esc(o.order_name || '-')}</td>
        <td>${esc(o.customer_name)}</td>
        <td>${o.items.length} items</td>
        <td>$${o.total_price.toFixed(2)}</td>
        <td><span class="badge badge-${o.status}">${o.status}</span></td>
        <td>${o.tracking_number ? '<a href="'+esc(o.tracking_url)+'" target="_blank">'+esc(o.tracking_number)+'</a>' : '-'}</td>
        <td>${new Date(o.created_at).toLocaleDateString('en-US')}</td>
        <td class="actions-cell">
          <button class="btn btn-sm btn-outline" onclick="viewOrder('${o.id}')">View</button>
        </td>
      </tr>`).join('');
  updateSelectedCount();
}

function toggleAllOrders(master) {
  document.querySelectorAll('.order-check').forEach(cb => cb.checked = master.checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const checked = document.querySelectorAll('.order-check:checked');
  const btn = document.getElementById('btn-create-picking');
  const count = document.getElementById('selected-count');
  count.textContent = checked.length;
  btn.style.display = checked.length > 0 ? '' : 'none';
}

async function createPickingList() {
  const checked = document.querySelectorAll('.order-check:checked');
  const orderIds = Array.from(checked).map(cb => cb.value);
  if (orderIds.length === 0) { toast('Select orders first', 'error'); return; }
  if (!confirm(`Create picking list for ${orderIds.length} order(s)?`)) return;
  try {
    const res = await fetch(API + '/picking-lists', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ order_ids: orderIds }),
    });
    if (res.ok) {
      const pl = await res.json();
      toast(`Picking list ${pl.picking_number} created (${pl.total_items} items)`);
      document.getElementById('select-all-orders').checked = false;
      document.querySelectorAll('.order-check').forEach(cb => cb.checked = false);
      updateSelectedCount();
      // Open packing station in new tab
      window.open('/packing/' + pl.id, '_blank');
    } else {
      const e = await res.json();
      toast(e.detail || 'Error creating picking list', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

document.getElementById('search-orders').addEventListener('input', () => renderOrders(allOrders));
document.getElementById('filter-status').addEventListener('change', loadOrders);

function updateServiceOptions(carrierSelId, serviceSelId, selectedService) {
  const carrier = document.getElementById(carrierSelId).value;
  const serviceSel = document.getElementById(serviceSelId);
  const services = CARRIERS[carrier] || [];
  const target = selectedService || (carrier === defaultCarrier ? defaultService : services[0] || '');
  serviceSel.innerHTML = services.map(s => `<option value="${s}" ${s === target ? 'selected' : ''}>${s}</option>`).join('');
}

function openOrderModal() {
  document.getElementById('o-order-name').value = '';
  document.getElementById('o-name').value = '';
  document.getElementById('o-email').value = '';
  document.getElementById('o-phone').value = '';
  document.getElementById('o-ship-name').value = '';
  document.getElementById('o-street1').value = '';
  document.getElementById('o-street2').value = '';
  document.getElementById('o-city').value = '';
  document.getElementById('o-state').value = '';
  document.getElementById('o-zip').value = '';
  document.getElementById('o-notes').value = '';
  document.getElementById('o-carrier').value = defaultCarrier;
  updateServiceOptions('o-carrier', 'o-service');
  document.getElementById('order-items-list').innerHTML = '';
  addOrderItemRow();
  document.getElementById('order-modal').classList.add('show');
}

function addOrderItemRow() {
  const div = document.createElement('div');
  div.className = 'order-item-row';
  div.style.flexWrap = 'wrap';
  div.innerHTML = `
    <div class="product-search-wrap">
      <input type="text" class="oi-search" placeholder="Search SKU or name..." autocomplete="off">
      <input type="hidden" class="oi-product-id">
      <input type="hidden" class="oi-product-variants">
      <div class="ps-dropdown"></div>
    </div>
    <select class="oi-variant" style="display:none"></select>
    <input type="number" class="oi-qty" value="1" min="1" style="max-width:80px" placeholder="SL">
    <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>
  `;
  document.getElementById('order-items-list').appendChild(div);
  initProductSearch(div);
}

function initProductSearch(row) {
  const wrap = row.querySelector('.product-search-wrap');
  const input = wrap.querySelector('.oi-search');
  const hiddenId = wrap.querySelector('.oi-product-id');
  const hiddenVariants = wrap.querySelector('.oi-product-variants');
  const dropdown = wrap.querySelector('.ps-dropdown');

  function renderDropdown(filter) {
    const q = (filter || '').toLowerCase();
    const filtered = allProducts.filter(p => {
      return p.sku.toLowerCase().includes(q) || p.name.toLowerCase().includes(q);
    });
    if (filtered.length === 0) {
      dropdown.innerHTML = '<div class="ps-empty">No products found</div>';
    } else {
      dropdown.innerHTML = filtered.map(p => {
        const qtyLabel = p.variants && p.variants.length > 0 ? p.variants.length + ' variants' : p.quantity;
        return `<div class="ps-item" data-id="${p.id}" data-variants='${JSON.stringify((p.variants||[]).map(v=>({id:v.id,sku:v.variant_sku,attrs:v.attributes,qty:v.quantity})))}'>
          <span><span class="ps-sku">${esc(p.sku)}</span><span class="ps-name">${esc(p.name)}</span></span>
          <span class="ps-qty">${qtyLabel}</span>
        </div>`;
      }).join('');
    }
    wrap.classList.add('open');
  }

  input.addEventListener('focus', () => renderDropdown(input.value));
  input.addEventListener('input', () => {
    hiddenId.value = '';
    hiddenVariants.value = '[]';
    renderDropdown(input.value);
  });

  dropdown.addEventListener('click', (e) => {
    const item = e.target.closest('.ps-item');
    if (!item) return;
    const pid = item.dataset.id;
    const variants = item.dataset.variants;
    const p = allProducts.find(x => x.id == pid);
    input.value = p.sku + ' - ' + p.name;
    hiddenId.value = pid;
    hiddenVariants.value = variants;
    wrap.classList.remove('open');
    onProductSearchSelect(row, JSON.parse(variants || '[]'));
  });

  document.addEventListener('click', (e) => {
    if (!wrap.contains(e.target)) wrap.classList.remove('open');
  });
}

function onProductSearchSelect(row, variants) {
  const variantSel = row.querySelector('.oi-variant');
  if (variants.length > 0) {
    variantSel.style.display = '';
    variantSel.innerHTML = variants.map(v => {
      const attrs = typeof v.attrs === 'string' ? JSON.parse(v.attrs) : (v.attrs || {});
      const label = Object.values(attrs).join(' / ') || v.sku;
      return `<option value="${v.id}">${esc(v.sku)} - ${label} (${v.qty})</option>`;
    }).join('');
  } else {
    variantSel.style.display = 'none';
    variantSel.innerHTML = '';
  }
}

async function saveOrder() {
  const rows = document.querySelectorAll('.order-item-row');
  const items = Array.from(rows).map(r => {
    const pid = r.querySelector('.oi-product-id');
    const item = {
      product_id: pid ? pid.value : '',
      quantity: parseInt(r.querySelector('.oi-qty').value) || 1,
    };
    const variantSel = r.querySelector('.oi-variant');
    if (variantSel && variantSel.style.display !== 'none' && variantSel.value) {
      item.variant_id = variantSel.value;
    }
    return item;
  });
  if (items.length === 0 || items.some(i => !i.product_id)) { toast('Please select a product for all rows', 'error'); return; }
  const body = {
    order_name: document.getElementById('o-order-name').value,
    customer_name: document.getElementById('o-name').value,
    customer_email: document.getElementById('o-email').value,
    customer_phone: document.getElementById('o-phone').value,
    ship_to: {
      name: document.getElementById('o-ship-name').value,
      street1: document.getElementById('o-street1').value,
      street2: document.getElementById('o-street2').value,
      city: document.getElementById('o-city').value,
      state: document.getElementById('o-state').value,
      zip: document.getElementById('o-zip').value,
    },
    items: items,
    carrier: document.getElementById('o-carrier').value,
    service: document.getElementById('o-service').value,
    notes: document.getElementById('o-notes').value,
  };
  const res = await fetch(API + '/orders', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res.ok) { toast('Order created'); closeModal('order-modal'); loadOrders(); }
  else { const e = await res.json(); toast(e.detail || 'Error creating order', 'error'); }
}

async function viewOrder(id) {
  const res = await fetch(API + '/orders/' + id);
  const o = await res.json();
  document.getElementById('order-detail-title').textContent = 'Order ' + o.order_number;
  document.getElementById('order-detail-body').innerHTML = `
    <div class="detail-grid">
      ${o.order_name ? '<div class="detail-item"><div class="label">Order Name</div><div class="value"><strong>' + esc(o.order_name) + '</strong></div></div>' : ''}
      <div class="detail-item"><div class="label">Customer</div><div class="value">${esc(o.customer_name)}</div></div>
      <div class="detail-item"><div class="label">Email</div><div class="value">${esc(o.customer_email) || '-'}</div></div>
      <div class="detail-item"><div class="label">Status</div><div class="value"><span class="badge badge-${o.status}">${o.status}</span></div></div>
      <div class="detail-item"><div class="label">Shipping</div><div class="value">${esc(o.carrier || 'USPS')} - ${esc(o.service || 'First')}</div></div>
      <div class="detail-item"><div class="label">Total</div><div class="value">$${o.total_price.toFixed(2)}</div></div>
      <div class="detail-item"><div class="label">Shipping Cost</div><div class="value">$${o.shipping_cost.toFixed(2)}</div></div>
      <div class="detail-item"><div class="label">Tracking</div><div class="value">${o.tracking_number ? '<a href="'+esc(o.tracking_url)+'" target="_blank">'+esc(o.tracking_number)+'</a>' : 'Not available'}</div></div>
    </div>
    <h3 style="margin:16px 0 8px;font-size:15px">Products</h3>
    <table>
      <thead><tr><th>SKU</th><th>Name</th><th>Variant</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead>
      <tbody>${o.items.map(i => `<tr><td>${esc(i.sku)}</td><td>${esc(i.product_name)}</td><td>${i.variant_label ? esc(i.variant_label) : '-'}</td><td>${i.quantity}</td><td>$${i.unit_price.toFixed(2)}</td><td>$${(i.quantity*i.unit_price).toFixed(2)}</td></tr>`).join('')}</tbody>
    </table>
    ${o.label_url ? '<div style="margin-top:12px"><a href="'+esc(o.label_url)+'" target="_blank" class="btn btn-sm btn-outline">View Shipping Label</a></div>' : ''}
    ${o.notes ? '<div style="margin-top:12px"><strong>Notes:</strong> '+esc(o.notes)+'</div>' : ''}
    <div style="margin-top:16px;text-align:center">
      <h4 style="margin:0 0 8px;font-size:14px">QR Code (Picking / Packing)</h4>
      <img src="${API}/orders/${o.id}/qrcode" alt="QR ${esc(o.order_number)}" style="max-width:280px;border-radius:8px">
      <div><a href="${API}/orders/${o.id}/qrcode" download="order-${o.order_number}.png" class="btn btn-outline btn-sm" style="margin-top:6px">Download QR</a></div>
    </div>
  `;

  const statusFlow = ['pending','confirmed','processing','packed','label_purchased','drop_off','shipped','in_transit','delivered'];
  const curIdx = statusFlow.indexOf(o.status);
  let footerHtml = '';
  if (o.status !== 'cancelled' && o.status !== 'delivered') {
    // Buy label - carrier/service selector + button
    if (!o.label_url && curIdx < 4) {
      const oCarrier = o.carrier || defaultCarrier;
      const oService = o.service || defaultService;
      const carrierOpts = Object.keys(CARRIERS).map(c => `<option value="${c}" ${c===oCarrier?'selected':''}>${c}</option>`).join('');
      const serviceOpts = (CARRIERS[oCarrier]||[]).map(s => `<option value="${s}" ${s===oService?'selected':''}>${s}</option>`).join('');
      footerHtml += `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="bl-carrier" onchange="updateServiceOptions('bl-carrier','bl-service')" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd">${carrierOpts}</select>
        <select id="bl-service" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd">${serviceOpts}</select>
        <button class="btn btn-outline" onclick="getRates('${o.id}')">Get Rates</button>
        <button class="btn btn-primary" onclick="buyLabel('${o.id}')">Buy Label</button>
      </div>
      <div id="rates-list" style="margin-top:8px"></div>`;
    }
    if (curIdx < statusFlow.length - 1) {
      const next = statusFlow[curIdx + 1];
      footerHtml += `<button class="btn btn-success" onclick="updateOrderStatus('${o.id}','${next}')">Move to: ${next}</button>`;
    }
    footerHtml += `<button class="btn btn-danger" onclick="cancelOrder('${o.id}')">Cancel Order</button>`;
  }
  document.getElementById('order-detail-footer').innerHTML = footerHtml;
  document.getElementById('order-detail-modal').classList.add('show');
}

async function updateOrderStatus(id, status) {
  const res = await fetch(API + '/orders/' + id + '/status', { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({status}) });
  if (res.ok) { toast('Status updated'); closeModal('order-detail-modal'); loadOrders(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function cancelOrder(id) {
  if (!confirm('Are you sure you want to cancel this order?')) return;
  const res = await fetch(API + '/orders/' + id + '/cancel', { method: 'POST' });
  if (res.ok) { toast('Order cancelled'); closeModal('order-detail-modal'); loadOrders(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

// GET RATES
async function getRates(orderId) {
  const ratesDiv = document.getElementById('rates-list');
  ratesDiv.innerHTML = '<em>Loading rates...</em>';
  try {
    const res = await fetch(API + '/orders/' + orderId + '/rates');
    if (!res.ok) {
      let errMsg;
      try { const e = await res.json(); errMsg = e.detail; } catch { errMsg = await res.text(); }
      ratesDiv.innerHTML = '<span style="color:red">' + esc(errMsg || 'Error loading rates') + '</span>';
      return;
    }
    const data = await res.json();
    const rates = data.rates || [];
    if (rates.length === 0) {
      ratesDiv.innerHTML = '<em style="color:orange">No rates available. Check recipient address and warehouse address (WAREHOUSE_* in .env).</em>';
      return;
    }
    ratesDiv.innerHTML = '<table style="width:100%;font-size:13px"><thead><tr><th>Carrier</th><th>Service</th><th>Rate</th><th>Days</th><th></th></tr></thead><tbody>' +
      rates.map(r => `<tr>
        <td>${esc(r.carrier)}</td><td>${esc(r.service)}</td>
        <td><strong>$${parseFloat(r.rate).toFixed(2)}</strong></td>
        <td>${r.delivery_days ? r.delivery_days + 'd' : '-'}</td>
        <td><button class="btn btn-sm btn-primary" onclick="document.getElementById('bl-carrier').value='${esc(r.carrier)}';updateServiceOptions('bl-carrier','bl-service','${esc(r.service)}')">Select</button></td>
      </tr>`).join('') + '</tbody></table>';
  } catch(e) { ratesDiv.innerHTML = '<span style="color:red">Error: ' + e.message + '</span>'; }
}

// BUY LABEL
async function buyLabel(orderId) {
  const carrierEl = document.getElementById('bl-carrier');
  const serviceEl = document.getElementById('bl-service');
  const carrier = carrierEl ? carrierEl.value : defaultCarrier;
  const service = serviceEl ? serviceEl.value : defaultService;
  if (!confirm(`Buy label: ${carrier} ${service}?\nDimensions and weight will be calculated from products.`)) return;
  toast('Purchasing label...', 'success');
  const res = await fetch(API + '/orders/' + orderId + '/buy-label', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({carrier, service}),
  });
  if (res.ok) {
    toast(`Label purchased: ${carrier} ${service}`);
    closeModal('order-detail-modal');
    loadOrders();
  } else {
    try { const e = await res.json(); toast(e.detail || 'Error buying label', 'error'); }
    catch { toast('Error buying label', 'error'); }
  }
}

// === INVENTORY TAB ===

function switchInvTab(tab) {
  document.querySelectorAll('.inv-tab').forEach(t => { t.classList.remove('active'); t.style.borderBottomColor = 'transparent'; t.style.color = '#666'; });
  document.querySelectorAll('.inv-panel').forEach(p => p.style.display = 'none');
  const el = document.querySelector(`.inv-tab[data-inv="${tab}"]`);
  if (el) { el.classList.add('active'); el.style.borderBottomColor = '#667eea'; el.style.color = '#667eea'; }
  document.getElementById(tab === 'overview' ? 'inv-overview' : 'inv-stock-requests').style.display = '';
}
// init first tab style
document.querySelector('.inv-tab.active').style.borderBottomColor = '#667eea';
document.querySelector('.inv-tab.active').style.color = '#667eea';

// --- Inventory Overview ---
let invOverviewData = [];

async function loadInventoryOverview() {
  const res = await fetch(API + '/reports/inventory-overview');
  invOverviewData = await res.json();
  renderInventoryOverview(invOverviewData);
}

function renderInventoryOverview(data) {
  const q = (document.getElementById('search-inventory').value || '').toLowerCase();
  const filtered = data.filter(r => !q || r.sku.toLowerCase().includes(q) || r.name.toLowerCase().includes(q) || (r.variant_sku && r.variant_sku.toLowerCase().includes(q)));
  document.getElementById('inv-overview-body').innerHTML = filtered.length === 0
    ? '<tr><td colspan="9" class="empty">No data available</td></tr>'
    : filtered.map(r => {
      const diff = r.requested - r.received;
      const diffClass = diff > 0 ? 'stock-low' : '';
      return `<tr>
        <td><strong>${esc(r.variant_sku || r.sku)}</strong></td>
        <td>${esc(r.name)}</td>
        <td>${r.variant_label ? esc(r.variant_label) : '-'}</td>
        <td>${r.requested}</td>
        <td>${r.received}${diff > 0 ? ' <span class="stock-low" style="font-size:11px">(short ' + diff + ')</span>' : ''}</td>
        <td>${r.sold}</td>
        <td>${r.adjusted}</td>
        <td class="${r.current_stock <= 5 ? 'stock-low' : 'stock-ok'}">${r.current_stock}</td>
        <td>${esc(r.location)}</td>
      </tr>`;
    }).join('');
}

document.getElementById('search-inventory').addEventListener('input', () => renderInventoryOverview(invOverviewData));

// --- Stock Requests ---
let allStockRequests = [];

async function loadStockRequests() {
  const status = document.getElementById('filter-sr-status').value;
  const url = status ? API + '/stock-requests?status=' + status : API + '/stock-requests';
  const res = await fetch(url);
  allStockRequests = await res.json();
  renderStockRequests(allStockRequests);
}

function renderStockRequests(list) {
  const q = (document.getElementById('search-sr').value || '').toLowerCase();
  const filtered = list.filter(sr => !q || sr.request_number.toLowerCase().includes(q) || sr.supplier.toLowerCase().includes(q));
  document.getElementById('sr-body').innerHTML = filtered.length === 0
    ? '<tr><td colspan="8" class="empty">No stock requests found</td></tr>'
    : filtered.map(sr => {
      const totalReq = sr.items.reduce((s, i) => s + i.quantity_requested, 0);
      const totalRcv = sr.items.reduce((s, i) => s + i.quantity_received, 0);
      return `<tr>
        <td><strong>${esc(sr.request_number)}</strong></td>
        <td>${esc(sr.supplier) || '-'}</td>
        <td>${sr.items.length}</td>
        <td>${totalReq}</td>
        <td>${totalRcv}</td>
        <td><span class="badge badge-${sr.status}">${sr.status}</span></td>
        <td>${new Date(sr.created_at).toLocaleDateString('en-US')}</td>
        <td class="actions-cell">
          <button class="btn btn-sm btn-outline" onclick="viewStockRequest('${sr.id}')">View</button>
        </td>
      </tr>`;
    }).join('');
}

document.getElementById('search-sr').addEventListener('input', () => renderStockRequests(allStockRequests));
document.getElementById('filter-sr-status').addEventListener('change', loadStockRequests);

function openStockRequestModal() {
  document.getElementById('sr-supplier').value = '';
  document.getElementById('sr-notes').value = '';
  document.getElementById('sr-items-list').innerHTML = '';
  addSrItemRow();
  document.getElementById('sr-create-modal').classList.add('show');
}

function addSrItemRow() {
  const div = document.createElement('div');
  div.className = 'order-item-row';
  div.style.flexWrap = 'wrap';
  div.innerHTML = `
    <div class="product-search-wrap">
      <input type="text" class="oi-search" placeholder="Search SKU or name..." autocomplete="off">
      <input type="hidden" class="oi-product-id">
      <input type="hidden" class="oi-product-variants">
      <div class="ps-dropdown"></div>
    </div>
    <select class="sri-variant" style="display:none"></select>
    <input type="number" class="sri-qty" value="1" min="1" style="max-width:80px" placeholder="SL">
    <input type="number" class="sri-cost" value="0" step="0.01" style="max-width:100px" placeholder="Unit cost">
    <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>
  `;
  document.getElementById('sr-items-list').appendChild(div);
  initProductSearchSr(div);
}

function initProductSearchSr(row) {
  const wrap = row.querySelector('.product-search-wrap');
  const input = wrap.querySelector('.oi-search');
  const hiddenId = wrap.querySelector('.oi-product-id');
  const hiddenVariants = wrap.querySelector('.oi-product-variants');
  const dropdown = wrap.querySelector('.ps-dropdown');

  function renderDropdown(filter) {
    const q = (filter || '').toLowerCase();
    const filtered = allProducts.filter(p => p.sku.toLowerCase().includes(q) || p.name.toLowerCase().includes(q));
    if (filtered.length === 0) {
      dropdown.innerHTML = '<div class="ps-empty">No products found</div>';
    } else {
      dropdown.innerHTML = filtered.map(p => {
        return `<div class="ps-item" data-id="${p.id}" data-variants='${JSON.stringify((p.variants||[]).map(v=>({id:v.id,sku:v.variant_sku,attrs:v.attributes})))}'>
          <span><span class="ps-sku">${esc(p.sku)}</span><span class="ps-name">${esc(p.name)}</span></span>
        </div>`;
      }).join('');
    }
    wrap.classList.add('open');
  }

  input.addEventListener('focus', () => renderDropdown(input.value));
  input.addEventListener('input', () => { hiddenId.value = ''; renderDropdown(input.value); });

  dropdown.addEventListener('click', (e) => {
    const item = e.target.closest('.ps-item');
    if (!item) return;
    const pid = item.dataset.id;
    const variants = item.dataset.variants;
    const p = allProducts.find(x => x.id == pid);
    input.value = p.sku + ' - ' + p.name;
    hiddenId.value = pid;
    hiddenVariants.value = variants;
    wrap.classList.remove('open');
    const variantSel = row.querySelector('.sri-variant');
    const parsedV = JSON.parse(variants || '[]');
    if (parsedV.length > 0) {
      variantSel.style.display = '';
      variantSel.innerHTML = parsedV.map(v => {
        const attrs = typeof v.attrs === 'string' ? JSON.parse(v.attrs) : (v.attrs || {});
        const label = Object.values(attrs).join(' / ') || v.sku;
        return `<option value="${v.id}">${esc(v.sku)} - ${label}</option>`;
      }).join('');
    } else {
      variantSel.style.display = 'none';
      variantSel.innerHTML = '';
    }
  });

  document.addEventListener('click', (e) => {
    if (!wrap.contains(e.target)) wrap.classList.remove('open');
  });
}

async function saveStockRequest() {
  const rows = document.querySelectorAll('#sr-items-list .order-item-row');
  const items = Array.from(rows).map(r => {
    const pid = r.querySelector('.oi-product-id');
    const item = {
      product_id: pid ? pid.value : '',
      quantity_requested: parseInt(r.querySelector('.sri-qty').value) || 1,
      unit_cost: parseFloat(r.querySelector('.sri-cost').value) || 0,
    };
    const variantSel = r.querySelector('.sri-variant');
    if (variantSel && variantSel.style.display !== 'none' && variantSel.value) {
      item.variant_id = variantSel.value;
    }
    return item;
  });
  if (items.length === 0 || items.some(i => !i.product_id)) { toast('Please select a product for all rows', 'error'); return; }
  const body = {
    supplier: document.getElementById('sr-supplier').value,
    notes: document.getElementById('sr-notes').value,
    items,
  };
  const res = await fetch(API + '/stock-requests', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res.ok) { toast('Stock request created'); closeModal('sr-create-modal'); loadStockRequests(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function viewStockRequest(id) {
  const res = await fetch(API + '/stock-requests/' + id);
  const sr = await res.json();
  document.getElementById('sr-detail-title').textContent = 'Stock Request ' + sr.request_number;

  const isReceiving = sr.status === 'approved' || sr.status === 'receiving';

  let itemsHtml = sr.items.map(i => {
    const diff = i.quantity_requested - i.quantity_received;
    return `<tr>
      <td>${esc(i.sku)}</td>
      <td>${esc(i.product_name)}</td>
      <td>${i.variant_label ? esc(i.variant_label) : '-'}</td>
      <td>${i.quantity_requested}</td>
      <td>${isReceiving
        ? '<input type="number" class="rcv-qty" data-item-id="'+i.id+'" value="'+i.quantity_received+'" min="0" style="width:80px;padding:6px 8px;border:1px solid #ddd;border-radius:6px">'
        : i.quantity_received + (diff > 0 ? ' <span class="stock-low" style="font-size:11px">(short ' + diff + ')</span>' : '')}</td>
      <td>$${i.unit_cost.toFixed(2)}</td>
    </tr>`;
  }).join('');

  document.getElementById('sr-detail-body').innerHTML = `
    <div class="detail-grid">
      <div class="detail-item"><div class="label">Supplier</div><div class="value">${esc(sr.supplier) || '-'}</div></div>
      <div class="detail-item"><div class="label">Status</div><div class="value"><span class="badge badge-${sr.status}">${sr.status}</span></div></div>
      <div class="detail-item"><div class="label">Created</div><div class="value">${new Date(sr.created_at).toLocaleString('en-US')}</div></div>
      <div class="detail-item"><div class="label">Notes</div><div class="value">${esc(sr.notes) || '-'}</div></div>
    </div>
    <h3 style="margin:16px 0 8px;font-size:15px">Product List</h3>
    <table>
      <thead><tr><th>SKU</th><th>Name</th><th>Variant</th><th>Requested</th><th>Received</th><th>Unit Cost</th></tr></thead>
      <tbody>${itemsHtml}</tbody>
    </table>
  `;

  let footerHtml = '';
  if (sr.status === 'pending') {
    footerHtml += `<button class="btn btn-success" onclick="approveStockRequest('${sr.id}')">Approve</button>`;
    footerHtml += `<button class="btn btn-danger" onclick="cancelStockRequest('${sr.id}')">Cancel</button>`;
  } else if (sr.status === 'approved' || sr.status === 'receiving') {
    footerHtml += `<button class="btn btn-primary" onclick="receiveStockRequest('${sr.id}')">Save Received Qty</button>`;
    if (sr.status === 'receiving') {
      footerHtml += `<button class="btn btn-success" onclick="completeStockRequest('${sr.id}')">Complete</button>`;
    }
    footerHtml += `<button class="btn btn-danger" onclick="cancelStockRequest('${sr.id}')">Cancel</button>`;
  }
  document.getElementById('sr-detail-footer').innerHTML = footerHtml;
  document.getElementById('sr-detail-modal').classList.add('show');
}

async function approveStockRequest(id) {
  const res = await fetch(API + '/stock-requests/' + id + '/approve', { method: 'POST' });
  if (res.ok) { toast('Request approved'); closeModal('sr-detail-modal'); loadStockRequests(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function receiveStockRequest(id) {
  const inputs = document.querySelectorAll('.rcv-qty');
  const items = Array.from(inputs).map(inp => ({
    item_id: inp.dataset.itemId,
    quantity_received: parseInt(inp.value) || 0,
  }));
  const res = await fetch(API + '/stock-requests/' + id + '/receive', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ items }),
  });
  if (res.ok) { toast('Received quantities saved'); closeModal('sr-detail-modal'); loadStockRequests(); loadInventoryOverview(); loadProducts(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function completeStockRequest(id) {
  const res = await fetch(API + '/stock-requests/' + id + '/complete', { method: 'POST' });
  if (res.ok) { toast('Request completed'); closeModal('sr-detail-modal'); loadStockRequests(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function cancelStockRequest(id) {
  if (!confirm('Cancel this stock request?')) return;
  const res = await fetch(API + '/stock-requests/' + id + '/cancel', { method: 'POST' });
  if (res.ok) { toast('Request cancelled'); closeModal('sr-detail-modal'); loadStockRequests(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

// REPORTS
async function loadReports() {
  const [invRes, ordRes, topRes, lowRes] = await Promise.all([
    fetch(API + '/reports/inventory'),
    fetch(API + '/reports/orders'),
    fetch(API + '/reports/top-products'),
    fetch(API + '/products/low-stock?threshold=10'),
  ]);
  const inv = await invRes.json();
  const ord = await ordRes.json();
  const top = await topRes.json();
  const low = await lowRes.json();

  document.getElementById('report-cards').innerHTML = `
    <div class="report-card"><div class="number">${inv.total_products ?? 0}</div><div class="label">Total Products</div></div>
    <div class="report-card"><div class="number">${inv.total_quantity ?? 0}</div><div class="label">Total Stock</div></div>
    <div class="report-card"><div class="number">$${(inv.total_value ?? 0).toFixed(2)}</div><div class="label">Inventory Value</div></div>
    <div class="report-card"><div class="number">${ord.total_orders ?? 0}</div><div class="label">Total Orders</div></div>
    <div class="report-card"><div class="number">$${(ord.total_revenue ?? 0).toFixed(2)}</div><div class="label">Revenue</div></div>
    <div class="report-card"><div class="number">${inv.low_stock_count ?? 0}</div><div class="label">Low Stock</div></div>
  `;

  const topList = Array.isArray(top) ? top : (top.products || []);
  document.getElementById('top-products-body').innerHTML = topList.length === 0
    ? '<tr><td colspan="5" class="empty">No data yet</td></tr>'
    : topList.map((p,i) => `<tr><td>${i+1}</td><td>${esc(p.sku||'')}</td><td>${esc(p.product_name||p.name||'')}</td><td>${p.total_sold||p.quantity_sold||0}</td><td>$${(p.total_revenue||p.revenue||0).toFixed(2)}</td></tr>`).join('');

  document.getElementById('low-stock-body').innerHTML = low.length === 0
    ? '<tr><td colspan="4" class="empty">All products are well-stocked</td></tr>'
    : low.map(p => `<tr><td>${esc(p.sku)}</td><td>${esc(p.name)}</td><td class="stock-low">${p.quantity}</td><td>${esc(p.location)}</td></tr>`).join('');
}

function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

// Auth
let currentUser = null;
async function loadCurrentUser() {
  try {
    const res = await fetch('/api/v1/auth/me');
    if (res.ok) {
      currentUser = await res.json();
      document.getElementById('current-user').textContent = currentUser.display_name || currentUser.username;
      if (currentUser.role === 'admin') {
        document.getElementById('tab-users').style.display = '';
      }
    }
  } catch {}
}
async function doLogout() {
  await fetch('/api/v1/auth/logout', { method: 'POST' });
  window.location.href = '/login';
}
// Close user dropdown when clicking elsewhere
document.addEventListener('click', e => {
  const dd = document.getElementById('user-menu');
  if (dd && !e.target.closest('.user-dropdown')) dd.classList.remove('open');
});

// ---- User Management ----
let usersData = [];
const avatarColors = ['#667eea','#764ba2','#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1','#e83e8c','#fd7e14','#20c997'];

function getAvatarColor(name) { let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h); return avatarColors[Math.abs(h)%avatarColors.length]; }

function switchUmTab(name) {
  document.querySelectorAll('.um-tab').forEach(t => { t.classList.toggle('active', t.dataset.um === name); });
  document.querySelectorAll('.um-panel').forEach(p => { p.style.display = p.id === 'um-' + name ? '' : 'none'; });
}

async function loadUsers() {
  try {
    const res = await fetch(API + '/auth/users');
    if (!res.ok) return;
    usersData = await res.json();
    renderUserStats();
    renderUserCards();
    // Populate activity filter
    const filter = document.getElementById('activity-user-filter');
    const cur = filter.value;
    filter.innerHTML = '<option value="">All users</option>' + usersData.map(u => `<option value="${u.id}">${esc(u.username)}</option>`).join('');
    filter.value = cur;
  } catch {}
}

function renderUserStats() {
  const total = usersData.length;
  const active = usersData.filter(u => u.active).length;
  const admins = usersData.filter(u => u.role === 'admin').length;
  const staff = usersData.filter(u => u.role === 'staff').length;
  document.getElementById('user-stats').innerHTML = `
    <div class="user-stat-card">
      <div class="stat-icon" style="background:#e8f0fe"><svg viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div>
      <div class="stat-info"><div class="stat-num">${total}</div><div class="stat-label">Total Users</div></div>
    </div>
    <div class="user-stat-card">
      <div class="stat-icon" style="background:#d4edda"><svg viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div class="stat-info"><div class="stat-num">${active}</div><div class="stat-label">Active</div></div>
    </div>
    <div class="user-stat-card">
      <div class="stat-icon" style="background:#e8daef"><svg viewBox="0 0 24 24" fill="none" stroke="#6f42c1" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
      <div class="stat-info"><div class="stat-num">${admins}</div><div class="stat-label">Admins</div></div>
    </div>
    <div class="user-stat-card">
      <div class="stat-icon" style="background:#fff3cd"><svg viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="stat-info"><div class="stat-num">${staff}</div><div class="stat-label">Staff</div></div>
    </div>`;
}

function renderUserCards() {
  const q = (document.getElementById('search-users').value || '').toLowerCase();
  const filtered = q ? usersData.filter(u => u.username.toLowerCase().includes(q) || u.display_name.toLowerCase().includes(q)) : usersData;
  if (filtered.length === 0) {
    document.getElementById('user-cards-grid').innerHTML = '<div class="empty">No users found</div>';
    return;
  }
  document.getElementById('user-cards-grid').innerHTML = filtered.map(u => {
    const isSelf = currentUser && currentUser.id === u.id;
    const initials = (u.display_name || u.username).split(' ').map(w => w[0]).join('').slice(0,2);
    const color = getAvatarColor(u.username);
    return `<div class="user-card${u.active ? '' : ' disabled'}">
      ${isSelf ? '<div class="uc-self">YOU</div>' : ''}
      <div class="uc-top">
        <div class="uc-avatar" style="background:${color}">${esc(initials)}</div>
        <div class="uc-info">
          <div class="uc-name">${esc(u.display_name || u.username)}</div>
          <div class="uc-username">@${esc(u.username)}</div>
        </div>
      </div>
      <div class="uc-meta">
        <span class="badge badge-${u.role === 'admin' ? 'processing' : 'pending'}">${u.role}</span>
        <span class="badge badge-${u.active ? 'delivered' : 'cancelled'}">${u.active ? 'Active' : 'Disabled'}</span>
        <span style="font-size:11px;color:#aaa">${u.created_at ? 'Joined ' + new Date(u.created_at).toLocaleDateString() : ''}</span>
      </div>
      <div class="uc-actions">
        <button class="btn btn-outline btn-sm" onclick="openEditUserModal('${u.id}')">
          <svg style="width:12px;height:12px;vertical-align:-1px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit
        </button>
        <button class="btn btn-outline btn-sm" onclick="openResetPwModal('${u.id}','${esc(u.username)}')">
          <svg style="width:12px;height:12px;vertical-align:-1px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
          Reset PW
        </button>
        ${!isSelf ? `<button class="btn btn-sm ${u.active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserActive('${u.id}')">
          ${u.active ? '<svg style="width:12px;height:12px;vertical-align:-1px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Disable' : '<svg style="width:12px;height:12px;vertical-align:-1px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Enable'}
        </button>` : ''}
      </div>
    </div>`;
  }).join('');
}

function filterUsers() { renderUserCards(); }

function selectRole(role) {
  document.getElementById('u-role').value = role;
  document.getElementById('role-opt-staff').classList.toggle('selected', role === 'staff');
  document.getElementById('role-opt-admin').classList.toggle('selected', role === 'admin');
}

function togglePwVis(inputId, el) {
  const inp = document.getElementById(inputId);
  if (inp.type === 'password') { inp.type = 'text'; el.textContent = 'Hide'; }
  else { inp.type = 'password'; el.textContent = 'Show'; }
}

function openCreateUserModal() {
  document.getElementById('user-modal-title').innerHTML = '<svg style="width:20px;height:20px;vertical-align:-4px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> New User';
  document.getElementById('user-edit-id').value = '';
  document.getElementById('u-username').value = '';
  document.getElementById('u-username').disabled = false;
  document.getElementById('u-display-name').value = '';
  document.getElementById('u-password').value = '';
  document.getElementById('u-password-group').style.display = '';
  selectRole('staff');
  openModal('create-user-modal');
}

function openEditUserModal(userId) {
  const u = usersData.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('user-modal-title').innerHTML = '<svg style="width:20px;height:20px;vertical-align:-4px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit User';
  document.getElementById('user-edit-id').value = u.id;
  document.getElementById('u-username').value = u.username;
  document.getElementById('u-username').disabled = true;
  document.getElementById('u-display-name').value = u.display_name;
  document.getElementById('u-password').value = '';
  document.getElementById('u-password-group').style.display = 'none';
  selectRole(u.role);
  openModal('create-user-modal');
}

async function saveUser() {
  const editId = document.getElementById('user-edit-id').value;
  const username = document.getElementById('u-username').value.trim();
  const displayName = document.getElementById('u-display-name').value.trim();
  const password = document.getElementById('u-password').value;
  const role = document.getElementById('u-role').value;

  if (!editId) {
    if (!username || !password) { toast('Username and password required', 'error'); return; }
    if (password.length < 4) { toast('Password must be at least 4 characters', 'error'); return; }
    try {
      const res = await fetch(API + '/auth/users', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username, password, display_name: displayName || username, role }),
      });
      if (res.ok) { toast('User created successfully'); closeModal('create-user-modal'); loadUsers(); }
      else { const e = await res.json().catch(()=>({})); toast(e.detail || 'Error creating user', 'error'); }
    } catch (err) { toast(err.message, 'error'); }
  } else {
    try {
      const res = await fetch(API + '/auth/users/' + editId, {
        method: 'PATCH', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ display_name: displayName, role }),
      });
      if (res.ok) { toast('User updated successfully'); closeModal('create-user-modal'); loadUsers(); }
      else { const e = await res.json().catch(()=>({})); toast(e.detail || 'Error updating user', 'error'); }
    } catch (err) { toast(err.message, 'error'); }
  }
}

async function toggleUserActive(userId) {
  const u = usersData.find(x => x.id === userId);
  if (!u) return;
  const action = u.active ? 'Disable' : 'Enable';
  if (!confirm(`${action} user "${u.username}"?`)) return;
  try {
    const res = await fetch(API + '/auth/users/' + userId + '/active', { method: 'PATCH' });
    if (res.ok) { toast(`User ${action.toLowerCase()}d`); loadUsers(); }
    else { const e = await res.json().catch(()=>({})); toast(e.detail || 'Error', 'error'); }
  } catch (err) { toast(err.message, 'error'); }
}

let resetPwUserId = '';
function openResetPwModal(userId, username) {
  resetPwUserId = userId;
  document.getElementById('reset-pw-user').textContent = username;
  document.getElementById('reset-pw-input').value = '';
  openModal('reset-pw-modal');
}

async function doResetPassword() {
  const pw = document.getElementById('reset-pw-input').value;
  if (!pw) { toast('Password required', 'error'); return; }
  if (pw.length < 4) { toast('Password must be at least 4 characters', 'error'); return; }
  try {
    const res = await fetch(API + '/auth/users/' + resetPwUserId + '/reset-password', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password: pw }),
    });
    if (res.ok) { toast('Password reset successfully'); closeModal('reset-pw-modal'); }
    else { const e = await res.json().catch(()=>({})); toast(e.detail || 'Error', 'error'); }
  } catch (err) { toast(err.message, 'error'); }
}

// Change own password
function openChangePwModal() {
  document.getElementById('change-pw-input').value = '';
  document.getElementById('change-pw-confirm').value = '';
  openModal('change-pw-modal');
}

async function doChangeOwnPassword() {
  const pw = document.getElementById('change-pw-input').value;
  const confirm = document.getElementById('change-pw-confirm').value;
  if (!pw) { toast('Password required', 'error'); return; }
  if (pw.length < 4) { toast('Password must be at least 4 characters', 'error'); return; }
  if (pw !== confirm) { toast('Passwords do not match', 'error'); return; }
  try {
    const res = await fetch(API + '/auth/change-password', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password: pw }),
    });
    if (res.ok) { toast('Password changed successfully'); closeModal('change-pw-modal'); }
    else { const e = await res.json().catch(()=>({})); toast(e.detail || 'Error', 'error'); }
  } catch (err) { toast(err.message, 'error'); }
}

// Activity logs
async function loadActivityLogs() {
  const userId = document.getElementById('activity-user-filter').value;
  const limit = document.getElementById('activity-limit').value;
  const actionFilter = document.getElementById('activity-action-filter').value;
  const body = document.getElementById('activity-log-body');
  body.innerHTML = '<tr><td colspan="5"><em>Loading...</em></td></tr>';
  try {
    let url = API + '/auth/activity?limit=' + limit;
    if (userId) url += '&user_id=' + userId;
    const res = await fetch(url);
    let logs = await res.json();
    if (actionFilter) logs = logs.filter(l => l.action === actionFilter);
    if (logs.length === 0) { body.innerHTML = '<tr><td colspan="5" class="empty">No activity</td></tr>'; return; }
    body.innerHTML = logs.map(l => `<tr>
      <td style="white-space:nowrap;font-size:12px">${new Date(l.created_at).toLocaleString()}</td>
      <td><strong>${esc(l.username)}</strong></td>
      <td><span class="action-badge action-${l.action}">${esc(l.action.replace(/_/g, ' '))}</span></td>
      <td style="font-size:13px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(l.detail)}</td>
      <td style="font-size:11px;color:#888">${esc(l.ip_address)}</td>
    </tr>`).join('');
  } catch (err) { body.innerHTML = '<tr><td colspan="5" style="color:red">' + err.message + '</td></tr>'; }
}

// Init
loadCurrentUser();
loadProducts();
loadOrders();
</script>
</body>
</html>
