<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Packing Station - Warehouse Manager</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#f0f2f5;color:#1a1a2e}
.header{background:linear-gradient(135deg,#17a2b8,#138496);color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.header h1{font-size:20px;font-weight:600}
.header a{color:#fff;text-decoration:none;font-size:13px;background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px}
.header a:hover{background:rgba(255,255,255,.3)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.08);margin-bottom:16px}
.card h3{margin-bottom:12px;font-size:16px;color:#333}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#667eea;color:#fff}.btn-primary:hover{background:#5a6fd6}
.btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
.btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
.btn-warning{background:#ffc107;color:#333}.btn-warning:hover{background:#e0a800}
.btn-outline{background:transparent;border:1px solid #667eea;color:#667eea}.btn-outline:hover{background:#667eea;color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-lg{padding:14px 28px;font-size:16px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.08)}
thead{background:#f8f9fa}
th{padding:12px 16px;text-align:left;font-weight:600;font-size:13px;color:#555;border-bottom:2px solid #e8e8e8}
td{padding:10px 16px;border-bottom:1px solid #f0f0f0;font-size:14px}
tr:hover{background:#f8f9ff}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-pending{background:#fff3cd;color:#856404}
.badge-confirmed,.badge-processing{background:#cce5ff;color:#004085}
.badge-packed,.badge-label_purchased{background:#d4edda;color:#155724}
.badge-drop_off{background:#17a2b8;color:#fff}
.badge-shipped,.badge-in_transit{background:#d1ecf1;color:#0c5460}
.badge-delivered{background:#28a745;color:#fff}
.badge-cancelled{background:#f8d7da;color:#721c24}
.badge-packing{background:#e8daef;color:#6c3483}
.badge-active{background:#cce5ff;color:#004085}
.badge-processing{background:#e8daef;color:#6c3483}
.badge-done{background:#28a745;color:#fff}
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;color:#fff;font-size:14px;z-index:300;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.toast-success{background:#28a745}
.toast-error{background:#dc3545}
.toast-info{background:#17a2b8}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Scanner */
.scan-area{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.scan-input-wrap{flex:1;min-width:300px}
.scan-input{width:100%;padding:16px 20px;border:2px solid #17a2b8;border-radius:12px;font-size:18px;outline:none;transition:.2s}
.scan-input:focus{border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.2)}
.scan-result{padding:16px;border-radius:12px;margin-bottom:16px;display:none;animation:slideIn .3s ease}
.scan-result.success{background:#d4edda;border:1px solid #c3e6cb;color:#155724;display:block}
.scan-result.error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;display:block}
.scan-result.complete{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;display:block}

/* Active order panel */
.active-order{border:2px solid #667eea;border-radius:12px;padding:20px;margin-bottom:16px;background:#f8f9ff;animation:slideIn .3s ease}
.active-order h3{color:#667eea;margin-bottom:12px;font-size:17px}
.active-order .ao-top{display:flex;gap:16px;align-items:start;flex-wrap:wrap}
.active-order .ao-info{flex:1;min-width:200px}
.active-order .ao-info p{margin:4px 0;font-size:14px}
.active-order .ao-qr{text-align:center}
.active-order .ao-qr img{width:100px;height:100px;border:1px solid #ddd;border-radius:8px}
.active-order .ao-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.active-order .ao-complete{margin-top:16px;padding:16px;border-top:2px solid #28a745;text-align:center;background:#f0fff0;border-radius:0 0 10px 10px}
.active-order .ao-complete p{font-size:16px;font-weight:600;color:#28a745;margin-bottom:12px}
.active-order .ao-waiting{margin-top:12px;padding:12px;background:#fff3cd;border-radius:8px;text-align:center;color:#856404;font-weight:500}

/* Progress bar */
.progress-bar{background:#e9ecef;border-radius:8px;height:24px;overflow:hidden;margin:8px 0}
.progress-fill{background:linear-gradient(90deg,#28a745,#20c997);height:100%;border-radius:8px;transition:width .5s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600;min-width:30px}

/* Order cards */
.order-card{border:1px solid #e8e8e8;border-radius:12px;padding:16px;margin-bottom:12px;transition:.2s}
.order-card.complete{border-color:#28a745;background:#f8fff8}
.order-card.dimmed{opacity:0.4}
.order-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.order-card-header h4{font-size:15px;color:#333}
.order-card-actions{display:flex;gap:6px;align-items:center}

/* Picking list selector */
.pl-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:20px}
.pl-card{border:1px solid #e8e8e8;border-radius:12px;padding:16px;cursor:pointer;transition:.2s}
.pl-card:hover{border-color:#17a2b8;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.pl-card.active{border-color:#17a2b8;background:#f0fafb}
.pl-card h4{font-size:15px;margin-bottom:4px}
.pl-card .meta{font-size:12px;color:#888}

.empty{text-align:center;padding:40px;color:#999;font-size:15px}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:0;width:600px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{padding:20px 24px;border-bottom:1px solid #e8e8e8;display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:18px}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#999;padding:0 4px}
.modal-close:hover{color:#333}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid #e8e8e8;display:flex;justify-content:flex-end;gap:10px}
</style>
</head>
<body>

<div class="header">
  <h1>Packing Station</h1>
  <div style="display:flex;gap:12px;align-items:center">
    <span id="header-info" style="font-size:13px;opacity:.8"></span>
    <span id="current-user" style="font-size:13px;opacity:.8"></span>
    <a href="/">Dashboard</a>
    <a href="#" onclick="doLogout()" style="color:#fff;text-decoration:none;font-size:13px;background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px">Logout</a>
  </div>
</div>

<div class="container">
  <!-- Picking List Selection -->
  <div id="pl-selector" class="card">
    <h3>Select Picking List</h3>
    <div class="pl-list" id="pl-list"></div>
    <div id="pl-empty" class="empty" style="display:none">No picking lists available. Create one from the Orders tab.</div>
  </div>

  <!-- Active Packing Session -->
  <div id="packing-session" style="display:none">
    <!-- Scanner -->
    <div class="card">
      <h3>Scan QR Code</h3>
      <div class="scan-area">
        <div class="scan-input-wrap">
          <input type="text" class="scan-input" id="scan-input" placeholder="Scan or type QR code (e.g. PICK-XXXXXXXX)..." autofocus>
        </div>
        <button class="btn btn-primary btn-lg" onclick="doScan()">Scan</button>
      </div>
      <div class="scan-result" id="scan-result"></div>
    </div>

    <!-- Active Order Panel (shown during packing cycle) -->
    <div id="active-order" class="active-order" style="display:none"></div>

    <!-- QR Codes Export -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="margin:0">Picking List: <span id="pl-number"></span></h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#555;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="checkbox" id="filter-needs-packing" onchange="renderOrderCards()" checked>
            Only needs packing
          </label>
          <button class="btn btn-outline btn-sm" onclick="exportPickingSummary()">Picking Summary</button>
          <button class="btn btn-outline btn-sm" onclick="exportQrCodes()">QR Labels (by SKU)</button>
          <button class="btn btn-outline btn-sm" onclick="refreshProgress()">Refresh</button>
          <button class="btn btn-danger btn-sm" id="unpack-batch-btn" onclick="unpackBatch()">Unpack Batch</button>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="total-progress" style="width:0%">0%</div>
      </div>
      <div style="font-size:13px;color:#888;margin-top:4px">
        <span id="progress-text">0 / 0 items picked</span>
      </div>
    </div>

    <!-- Orders Progress -->
    <div id="orders-progress"></div>
  </div>
</div>

<!-- Buy Label Modal -->
<div class="modal-overlay" id="label-modal">
  <div class="modal" style="width:500px">
    <div class="modal-header">
      <h2>Buy Shipping Label</h2>
      <button class="modal-close" onclick="closeLabelModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:12px"><strong>Order:</strong> <span id="lm-order-number"></span></p>
      <p style="margin-bottom:16px;color:#28a745;font-weight:600">All items picked! Ready for label.</p>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding:10px 12px;background:#f8f9fa;border-radius:8px;font-size:13px">
        <span style="font-weight:600;color:#555">Package:</span>
        <label style="display:flex;align-items:center;gap:3px">Wt(oz)<input id="lm-weight" type="number" step="0.1" min="0.1" style="width:70px;padding:4px 6px;border:1px solid #ccc;border-radius:4px" value="0"></label>
        <label style="display:flex;align-items:center;gap:3px">L(in)<input id="lm-length" type="number" step="0.1" min="0" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px" value="0"></label>
        <label style="display:flex;align-items:center;gap:3px">W(in)<input id="lm-width" type="number" step="0.1" min="0" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px" value="0"></label>
        <label style="display:flex;align-items:center;gap:3px">H(in)<input id="lm-height" type="number" step="0.1" min="0" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px" value="0"></label>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:12px">
        <div style="flex:1">
          <label style="font-size:13px;color:#555;display:block;margin-bottom:4px">Carrier</label>
          <select id="lm-carrier" onchange="updateLmService()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
            <option value="USPS">USPS</option><option value="UPS">UPS</option><option value="FedEx">FedEx</option>
          </select>
        </div>
        <div style="flex:1">
          <label style="font-size:13px;color:#555;display:block;margin-bottom:4px">Service</label>
          <select id="lm-service" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"></select>
        </div>
      </div>
      <div id="lm-rates" style="margin-bottom:12px"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeLabelModal()">Cancel</button>
      <button class="btn btn-outline" onclick="getLmRates()">Get Rates</button>
      <button id="btn-lm-buy" class="btn btn-primary" onclick="buyLmLabel()">Buy Label</button>
    </div>
  </div>
</div>

<script>
const API = '/api/v1';
let currentPL = null; // current picking list
let progressData = []; // per-order progress
let activeOrderId = null; // order currently being packed
let refreshTimer = null; // auto-refresh interval

const CARRIERS = {
  'USPS': ['GroundAdvantage', 'Priority', 'Express', 'ParcelSelect', 'LibraryMail', 'MediaMail', 'First'],
  'UPS': ['Ground', '3DaySelect', '2ndDayAir', '2ndDayAirAM', 'NextDayAirSaver', 'NextDayAir', 'NextDayAirEarlyAM'],
  'FedEx': ['GROUND_HOME_DELIVERY', 'FEDEX_GROUND', 'FEDEX_EXPRESS_SAVER', 'FEDEX_2_DAY', 'STANDARD_OVERNIGHT', 'PRIORITY_OVERNIGHT', 'FIRST_OVERNIGHT'],
};

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

// Load picking lists
async function loadPickingLists() {
  const res = await fetch(API + '/picking-lists');
  const lists = await res.json();
  const container = document.getElementById('pl-list');
  const empty = document.getElementById('pl-empty');

  if (lists.length === 0) {
    container.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  container.innerHTML = lists.map(pl => {
    const pct = pl.total_items > 0 ? Math.round(pl.picked_items / pl.total_items * 100) : 0;
    const canDelete = pl.status === 'active';
    return `<div class="pl-card ${currentPL && currentPL.id === pl.id ? 'active' : ''}" data-pl-id="${pl.id}" onclick="selectPickingList('${pl.id}')">
      <div style="display:flex;justify-content:space-between;align-items:start">
        <h4>${esc(pl.picking_number)}</h4>
        ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteBatch('${pl.id}','${esc(pl.picking_number)}')" style="padding:2px 8px;font-size:11px" title="Delete batch">&#10005;</button>` : ''}
      </div>
      <div class="meta">${pl.order_count} orders, ${pl.total_items} items</div>
      <div class="progress-bar" style="height:16px;margin-top:8px">
        <div class="progress-fill" style="width:${pct}%;${pct >= 100 ? 'background:#28a745' : ''}">${pct}%</div>
      </div>
      <div class="meta" style="margin-top:4px">${pl.picked_items}/${pl.total_items} picked | <span class="badge badge-${pl.status}">${pl.status}</span></div>
    </div>`;
  }).join('');
}

async function selectPickingList(plId) {
  const res = await fetch(API + '/picking-lists/' + plId);
  currentPL = await res.json();
  document.getElementById('pl-number').textContent = currentPL.picking_number;
  document.getElementById('header-info').textContent = currentPL.picking_number;
  document.getElementById('packing-session').style.display = '';
  document.getElementById('unpack-batch-btn').style.display = currentPL.status === 'active' ? '' : 'none';
  document.getElementById('scan-input').focus();

  // Highlight selected card
  document.querySelectorAll('.pl-card').forEach(c => c.classList.toggle('active', c.dataset.plId === plId));

  await refreshProgress();
  startAutoRefresh();
}

async function refreshProgress() {
  if (!currentPL) return;
  // Re-fetch picking list to get updated status
  const plRes = await fetch(API + '/picking-lists/' + currentPL.id);
  if (plRes.ok) {
    currentPL = await plRes.json();
    document.getElementById('unpack-batch-btn').style.display = currentPL.status === 'active' ? '' : 'none';
  }
  const res = await fetch(API + '/picking-lists/' + currentPL.id + '/progress');
  progressData = await res.json();

  // Update total progress
  let totalItems = 0, totalPicked = 0;
  progressData.forEach(o => { totalItems += o.total; totalPicked += o.picked; });
  const pct = totalItems > 0 ? Math.round(totalPicked / totalItems * 100) : 0;
  document.getElementById('total-progress').style.width = pct + '%';
  document.getElementById('total-progress').textContent = pct + '%';
  document.getElementById('progress-text').textContent = `${totalPicked} / ${totalItems} items picked`;

  // Render order cards
  renderOrderCards();
  showActiveOrder();

  // Refresh picking list selector cards too
  loadPickingLists();
}

function startAutoRefresh() {
  stopAutoRefresh();
  refreshTimer = setInterval(() => { if (currentPL) refreshProgress(); }, 5000);
}

function stopAutoRefresh() {
  if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
}

function renderOrderCards() {
  const container = document.getElementById('orders-progress');
  const filterNeeds = document.getElementById('filter-needs-packing').checked;

  let filtered = progressData;
  if (filterNeeds) {
    filtered = progressData.filter(o => o.picked < o.total || (o.picked >= o.total && !['drop_off','shipped','in_transit','delivered'].includes(o.order_status)));
  }

  if (filtered.length === 0 && progressData.length > 0) {
    container.innerHTML = '<div class="empty">All orders fully picked! Uncheck "Only needs packing" to see all.</div>';
    return;
  }

  container.innerHTML = filtered.map(o => {
    const pct = o.total > 0 ? Math.round(o.picked / o.total * 100) : 0;
    const isComplete = o.picked >= o.total;
    const hasLabel = !!o.label_url;

    const isDroppedOff = ['drop_off','shipped','in_transit','delivered'].includes(o.order_status);
    const isPending = o.order_status === 'pending';
    let actionsHtml = '';
    if (isPending) {
      actionsHtml += `<button class="btn btn-outline btn-sm" onclick="resumeOrder('${o.order_id}')">Resume</button>`;
    } else if (isComplete && !hasLabel) {
      actionsHtml = `<button class="btn btn-primary btn-sm" onclick="openLabelModal('${o.order_id}','${esc(o.order_number)}')">Buy Label</button>`;
    } else if (hasLabel) {
      if (!isDroppedOff) {
        actionsHtml = `<button class="btn btn-success btn-sm" onclick="printAndDropOff('${o.order_id}','${esc(o.label_url)}')">Print Label</button>`;
      }
      if (o.tracking_number) {
        actionsHtml += ` <span style="font-size:12px;color:#888">Track: ${esc(o.tracking_number)}</span>`;
      }
    }
    // Pending button - only if not already pending/dropped off
    if (!isPending && !isDroppedOff) {
      actionsHtml += ` <button class="btn btn-warning btn-sm" onclick="pauseOrder('${o.order_id}')" title="Pause this order">Pending</button>`;
    }
    // Unpack button - only for active batches
    if (currentPL && currentPL.status === 'active') {
      actionsHtml += ` <button class="btn btn-danger btn-sm" onclick="unpackOrder('${o.order_id}','${esc(o.order_number)}')" title="Remove from batch">Unpack</button>`;
    }

    const itemsHtml = o.items.map(i => `<tr style="${i.picked ? 'background:#f0fff0' : ''}">
      <td>${i.picked ? '<span style="color:#28a745;font-weight:700">&#10003;</span>' : '<span style="color:#ccc">&#9675;</span>'}</td>
      <td>${i.image_url ? `<img src="${esc(i.image_url)}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #e8e8e8" onerror="this.style.display='none';this.nextElementSibling.style.display=''"><span style="display:none;width:40px;height:40px;background:#f0f0f0;border-radius:6px"></span>` : '<span style="display:inline-block;width:40px;height:40px;background:#f0f0f0;border-radius:6px"></span>'}</td>
      <td><strong>${esc(i.sku)}</strong></td>
      <td>${esc(i.product_name)}</td>
      <td>${i.variant_label ? esc(i.variant_label) : '-'}</td>
      <td>#${i.sequence}</td>
      <td style="font-size:11px;color:#888;font-family:monospace">${esc(i.qr_code)}</td>
      <td>${i.picked_at ? new Date(i.picked_at).toLocaleTimeString() : '-'}</td>
    </tr>`).join('');

    return `<div class="card order-card ${isComplete ? 'complete' : ''} ${isDroppedOff || isPending ? 'dimmed' : ''}">
      <div class="order-card-header">
        <h4>${esc(o.order_number)} ${o.order_name ? '(' + esc(o.order_name) + ')' : ''} - ${esc(o.customer_name)}</h4>
        <div class="order-card-actions">
          <span class="badge badge-${o.order_status}">${o.order_status}</span>
          ${actionsHtml}
        </div>
      </div>
      <div class="progress-bar" style="height:16px">
        <div class="progress-fill" style="width:${pct}%;${isComplete ? 'background:#28a745' : ''}">${o.picked}/${o.total}</div>
      </div>
      <table style="margin-top:8px;box-shadow:none">
        <thead><tr><th style="width:30px"></th><th style="width:50px">Img</th><th>SKU</th><th>Product</th><th>Variant</th><th>Unit</th><th>QR Code</th><th>Picked At</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
      </table>
    </div>`;
  }).join('');
}

// Scanning
document.getElementById('scan-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); doScan(); }
});

// Global barcode capture — redirect keystrokes to scan input without needing focus
document.addEventListener('keydown', function(e) {
  const input = document.getElementById('scan-input');
  if (document.activeElement === input) return; // already focused
  // Ignore if user is typing in another input, textarea, select, or contenteditable
  const tag = document.activeElement?.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
  if (document.activeElement?.isContentEditable) return;
  // Ignore modifier combos (Ctrl+C, etc) except Shift
  if (e.ctrlKey || e.metaKey || e.altKey) return;
  // Only capture printable characters and Enter
  if (e.key === 'Enter') {
    e.preventDefault();
    input.focus();
    doScan();
    return;
  }
  if (e.key.length === 1) {
    e.preventDefault();
    input.focus();
    input.value += e.key;
  }
});

async function doScan() {
  const input = document.getElementById('scan-input');
  const code = input.value.trim();
  if (!code) return;

  const resultEl = document.getElementById('scan-result');

  // Check if this is a tracking number (shipping label scan) — skip QR validation
  const isTrackingNumber = progressData.some(x => x.tracking_number === code);

  // If active order, validate QR belongs to it before sending to server (skip for tracking numbers)
  if (!isTrackingNumber && activeOrderId && progressData.length > 0) {
    const activeOrder = progressData.find(x => x.order_id === activeOrderId);
    if (activeOrder) {
      const belongsToActive = activeOrder.items.some(i => i.qr_code === code);
      if (!belongsToActive) {
        const otherOrder = progressData.find(x => x.order_id !== activeOrderId && x.items.some(i => i.qr_code === code));
        if (otherOrder) {
          // If item is already picked, switch to that order (recall order for handling)
          const otherItem = otherOrder.items.find(i => i.qr_code === code);
          if (otherItem && otherItem.picked) {
            activeOrderId = otherOrder.order_id;
            resultEl.className = 'scan-result success';
            resultEl.textContent = `Switched to order ${otherOrder.order_number} (item already picked)`;
            toast(`Switched to ${otherOrder.order_number}`, 'info');
            showActiveOrder();
            renderOrderCards();
            input.value = '';
            input.focus();
            return;
          }
          // Unpicked item from another order — block
          resultEl.className = 'scan-result error';
          resultEl.textContent = `Wrong order! This item belongs to ${otherOrder.order_number}. Finish packing ${activeOrder.order_number} first.`;
        } else {
          resultEl.className = 'scan-result error';
          resultEl.textContent = `This QR code does not belong to order ${activeOrder.order_number}.`;
        }
        input.value = '';
        input.focus();
        return;
      }
    }
  }

  try {
    const res = await fetch(API + '/picking-lists/scan?qr_code=' + encodeURIComponent(code), { method: 'POST' });
    const data = await res.json();

    if (!res.ok) {
      resultEl.className = 'scan-result error';
      resultEl.textContent = data.detail || data.message || ('Server error: ' + res.status);
      input.value = '';
      input.focus();
      return;
    }

    if (data.success) {
      // Shipping label scanned → order marked as shipped
      if (data.label_scanned) {
        resultEl.className = 'scan-result complete';
        resultEl.textContent = data.message;
        toast(`${data.order_number} marked as Shipped!`, 'success');
        await refreshProgress();
        // Clear active order if it was the shipped one
        if (activeOrderId === data.order_id) {
          clearActiveOrder();
        }
        input.value = '';
        input.focus();
        return;
      }

      // Set active order on first scan
      const isFirstScan = !activeOrderId;
      if (!activeOrderId) {
        activeOrderId = data.order_id;
      }

      resultEl.className = 'scan-result ' + (data.order_complete ? 'complete' : 'success');
      let msg = data.message;
      msg += ` | Order: ${data.order_number} (${data.order_picked}/${data.order_total})`;
      if (data.order_complete) {
        if (data.has_label) {
          msg += ' | ORDER COMPLETE - Label ready! Opening print...';
        } else {
          msg += ' | ORDER COMPLETE - Ready for shipping label!';
        }
      }
      resultEl.textContent = msg;
      await refreshProgress();

      // Auto-open order label on first scan (for packing cover)
      if (isFirstScan) {
        printOrderLabel(data.order_id);
        toast('Print order label for packing cover');
      }

      // Auto print & drop-off if order complete and label already purchased
      if (data.order_complete && data.has_label) {
        const orderProgress = progressData.find(x => x.order_id === data.order_id);
        if (orderProgress && orderProgress.label_url) {
          toast('Label already purchased — printing & marking drop off', 'success');
          await printAndDropOff(data.order_id, orderProgress.label_url);
        }
      }

      // Update scanner placeholder
      const ao = progressData.find(x => x.order_id === activeOrderId);
      if (ao && ao.picked < ao.total) {
        input.placeholder = `Scan next item for ${ao.order_number} (${ao.picked}/${ao.total})...`;
      }
    } else {
      // Already picked — switch to that order (recall order for handling)
      if (data.order_id) {
        activeOrderId = data.order_id;
        resultEl.className = 'scan-result success';
        resultEl.textContent = `${data.message} — Switched to order ${data.order_number}`;
        toast(`Switched to ${data.order_number}`, 'info');
        showActiveOrder();
        renderOrderCards();
      } else {
        resultEl.className = 'scan-result error';
        resultEl.textContent = data.message;
      }
    }
  } catch (err) {
    resultEl.className = 'scan-result error';
    resultEl.textContent = 'Error: ' + err.message;
  }

  input.value = '';
  input.focus();
}

// Active order panel
function showActiveOrder() {
  const panel = document.getElementById('active-order');
  if (!activeOrderId) { panel.style.display = 'none'; return; }

  const o = progressData.find(x => x.order_id === activeOrderId);
  if (!o) { panel.style.display = 'none'; return; }

  panel.style.display = '';
  const pct = o.total > 0 ? Math.round(o.picked / o.total * 100) : 0;
  const isComplete = o.picked >= o.total;
  const hasLabel = !!o.label_url;
  const isDroppedOff = ['drop_off','shipped','in_transit','delivered'].includes(o.order_status);

  const itemsHtml = o.items.map(i => `<tr style="${i.picked ? 'background:#f0fff0' : ''}">
    <td>${i.picked ? '<span style="color:#28a745;font-weight:700">&#10003;</span>' : '<span style="color:#ccc">&#9675;</span>'}</td>
    <td>${i.image_url ? `<img src="${esc(i.image_url)}" style="width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid #e8e8e8" onerror="this.style.display='none';this.nextElementSibling.style.display=''"><span style="display:none;width:44px;height:44px;background:#f0f0f0;border-radius:6px"></span>` : '<span style="display:inline-block;width:44px;height:44px;background:#f0f0f0;border-radius:6px"></span>'}</td>
    <td><strong>${esc(i.sku)}</strong></td>
    <td>${esc(i.product_name)}</td>
    <td>${i.variant_label ? esc(i.variant_label) : '-'}</td>
    <td>#${i.sequence}</td>
  </tr>`).join('');

  let bottomHtml = '';
  if (isComplete && !isDroppedOff) {
    if (!hasLabel) {
      bottomHtml = `<div class="ao-complete">
        <p>All items picked!</p>
        <button class="btn btn-primary btn-lg" onclick="openLabelModal('${o.order_id}','${esc(o.order_number)}')">Buy Shipping Label</button>
      </div>`;
    } else {
      bottomHtml = `<div class="ao-complete">
        <p>All items picked! Ready to ship.</p>
        <button class="btn btn-success btn-lg" onclick="printAndDropOff('${o.order_id}','${esc(o.label_url)}')">Print Shipping Label & Drop Off</button>
      </div>`;
    }
  } else if (isDroppedOff) {
    bottomHtml = `<div class="ao-complete" style="border-color:#17a2b8;background:#e8f8fb">
      <p style="color:#17a2b8">Order dropped off!</p>
      <button class="btn btn-primary" onclick="clearActiveOrder()">Next Order</button>
    </div>`;
  } else {
    const remaining = o.total - o.picked;
    bottomHtml = `<div class="ao-waiting">Scan ${remaining} more item${remaining > 1 ? 's' : ''} for this order...</div>`;
  }

  panel.innerHTML = `
    <h3>Packing: ${esc(o.order_number)} ${o.order_name ? '(' + esc(o.order_name) + ')' : ''}</h3>
    <div class="ao-top">
      <div class="ao-info">
        <p><strong>Customer:</strong> ${esc(o.customer_name)}</p>
        <p><strong>Status:</strong> <span class="badge badge-${o.order_status}">${o.order_status}</span></p>
        <p><strong>Progress:</strong> ${o.picked} / ${o.total} items</p>
      </div>
      <div class="ao-qr">
        <img src="${API}/orders/${o.order_id}/qrcode" alt="Order QR" title="Order Label">
        <div style="margin-top:4px">
          <button class="btn btn-outline btn-sm" onclick="printOrderLabel('${o.order_id}')">Print Order Label</button>
        </div>
      </div>
    </div>
    <div class="ao-actions">
      <button class="btn btn-outline btn-sm" style="color:#999;border-color:#ccc" onclick="clearActiveOrder()">Skip Order</button>
    </div>
    <div class="progress-bar" style="height:20px;margin-top:12px">
      <div class="progress-fill" style="width:${pct}%;${isComplete ? 'background:#28a745' : ''}">${pct}%</div>
    </div>
    <table style="margin-top:12px;box-shadow:none;font-size:13px">
      <thead><tr><th style="width:30px"></th><th style="width:50px">Img</th><th>SKU</th><th>Product</th><th>Variant</th><th>Unit</th></tr></thead>
      <tbody>${itemsHtml}</tbody>
    </table>
    ${bottomHtml}
  `;
}

function clearActiveOrder() {
  activeOrderId = null;
  document.getElementById('active-order').style.display = 'none';
  document.getElementById('scan-result').className = 'scan-result';
  document.getElementById('scan-input').placeholder = 'Scan or type QR code (e.g. PICK-XXXXXXXX)...';
  document.getElementById('scan-input').focus();
}

function printOrderLabel(orderId) {
  window.open(API + '/orders/' + orderId + '/qrcode', '_blank');
}

// Export QR codes
function exportQrCodes() {
  if (!currentPL) return;
  window.open(API + '/picking-lists/' + currentPL.id + '/qrcodes', '_blank');
}

function exportPickingSummary() {
  if (!currentPL) return;
  window.open(API + '/picking-lists/' + currentPL.id + '/picking-summary', '_blank');
}

async function pauseOrder(orderId) {
  const res = await fetch(API + '/orders/' + orderId + '/status', {
    method: 'PATCH', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({status: 'pending', note: 'Paused from packing station'}),
  });
  if (res.ok) { toast('Order paused'); refreshProgress(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

async function resumeOrder(orderId) {
  const res = await fetch(API + '/orders/' + orderId + '/status', {
    method: 'PATCH', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({status: 'processing', note: 'Resumed from packing station'}),
  });
  if (res.ok) { toast('Order resumed'); refreshProgress(); }
  else { const e = await res.json(); toast(e.detail || 'Error', 'error'); }
}

// Label modal
let labelOrderId = '';

function openLabelModal(orderId, orderNumber) {
  labelOrderId = orderId;
  document.getElementById('lm-order-number').textContent = orderNumber;
  document.getElementById('lm-carrier').value = 'USPS';
  updateLmService();
  document.getElementById('lm-rates').innerHTML = '';
  // Reset parcel fields
  document.getElementById('lm-weight').value = 0;
  document.getElementById('lm-length').value = 0;
  document.getElementById('lm-width').value = 0;
  document.getElementById('lm-height').value = 0;
  // Reset buy button state
  const btn = document.getElementById('btn-lm-buy');
  if (btn) { btn.disabled = false; btn.textContent = 'Buy Label'; }
  document.getElementById('label-modal').classList.add('show');
  // Load parcel info
  fetch(API + '/orders/' + orderId + '/parcel-info').then(r => r.json()).then(p => {
    document.getElementById('lm-weight').value = p.weight || 0;
    document.getElementById('lm-length').value = p.length || 0;
    document.getElementById('lm-width').value = p.width || 0;
    document.getElementById('lm-height').value = p.height || 0;
  }).catch(() => {});
}

function closeLabelModal() {
  document.getElementById('label-modal').classList.remove('show');
}

function updateLmService(selectedService) {
  const carrier = document.getElementById('lm-carrier').value;
  const services = CARRIERS[carrier] || [];
  const sel = document.getElementById('lm-service');
  // If selectedService not in list, add it so the dropdown always shows the picked rate
  if (selectedService && !services.includes(selectedService)) services.push(selectedService);
  sel.innerHTML = services.map(s => `<option value="${s}" ${s === selectedService ? 'selected' : ''}>${s}</option>`).join('');
  if (selectedService) sel.value = selectedService;
}

function selectLmRate(idx) {
  const r = window._lmRates && window._lmRates[idx];
  if (!r) return;
  document.getElementById('lm-carrier').value = r.carrier;
  updateLmService(r.service);
  toast(`Selected ${r.carrier} ${r.service} — $${parseFloat(r.rate).toFixed(2)}`, 'info');
  // Highlight selected row
  document.querySelectorAll('#lm-rates tr').forEach(tr => tr.style.background = '');
  const row = document.querySelector(`#lm-rates tr[data-idx="${idx}"]`);
  if (row) row.style.background = '#e8f5e9';
}

function _getLmParcelParams() {
  const w = parseFloat(document.getElementById('lm-weight')?.value) || 0;
  const l = parseFloat(document.getElementById('lm-length')?.value) || 0;
  const wi = parseFloat(document.getElementById('lm-width')?.value) || 0;
  const h = parseFloat(document.getElementById('lm-height')?.value) || 0;
  const params = new URLSearchParams();
  if (w > 0) params.set('weight_oz', w);
  if (l > 0) params.set('length_in', l);
  if (wi > 0) params.set('width_in', wi);
  if (h > 0) params.set('height_in', h);
  return params.toString();
}

async function getLmRates() {
  const div = document.getElementById('lm-rates');
  div.innerHTML = '<em>Loading rates...</em>';
  try {
    const qs = _getLmParcelParams();
    const res = await fetch(API + '/orders/' + labelOrderId + '/rates' + (qs ? '?' + qs : ''));
    if (!res.ok) {
      const e = await res.json().catch(() => ({}));
      div.innerHTML = '<span style="color:red">' + esc(e.detail || 'Error') + '</span>';
      return;
    }
    const data = await res.json();
    const rates = data.rates || [];
    if (rates.length === 0) { div.innerHTML = '<em style="color:orange">No rates available</em>'; return; }
    window._lmRates = rates;
    div.innerHTML = '<table style="font-size:12px;box-shadow:none"><thead><tr><th>Carrier</th><th>Service</th><th>Rate</th><th>Days</th><th></th></tr></thead><tbody>' +
      rates.map((r, i) => `<tr data-idx="${i}"><td>${esc(r.carrier)}</td><td>${esc(r.service)}</td><td><strong>$${parseFloat(r.rate).toFixed(2)}</strong></td><td>${r.delivery_days || '-'}</td><td><button class="btn btn-sm btn-outline" onclick="selectLmRate(${i})">Select</button></td></tr>`).join('') +
      '</tbody></table>';
  } catch (err) { div.innerHTML = '<span style="color:red">' + err.message + '</span>'; }
}

let _buyingLmLabel = false;
async function buyLmLabel() {
  if (_buyingLmLabel) return;
  const carrier = document.getElementById('lm-carrier').value;
  const service = document.getElementById('lm-service').value;
  const w = parseFloat(document.getElementById('lm-weight')?.value) || 0;
  const l = parseFloat(document.getElementById('lm-length')?.value) || 0;
  const wi = parseFloat(document.getElementById('lm-width')?.value) || 0;
  const h = parseFloat(document.getElementById('lm-height')?.value) || 0;
  const dimStr = w > 0 ? `\nWeight: ${w}oz` + (l > 0 ? ` | ${l} x ${wi} x ${h} in` : '') : '';
  if (!confirm(`Buy label: ${carrier} ${service}?${dimStr}`)) return;

  _buyingLmLabel = true;
  const btn = document.getElementById('btn-lm-buy');
  if (btn) { btn.disabled = true; btn.textContent = 'Purchasing...'; }

  try {
    toast('Purchasing label...');
    const body = { carrier, service };
    if (w > 0) { body.weight_oz = w; body.length_in = l; body.width_in = wi; body.height_in = h; }
    const res = await fetch(API + '/orders/' + labelOrderId + '/buy-label', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body),
    });
    if (res.ok) {
      toast('Label purchased!');
      closeLabelModal();
      await refreshProgress();
    } else {
      const e = await res.json().catch(() => ({}));
      toast(e.detail || 'Error buying label', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
  finally {
    _buyingLmLabel = false;
    if (btn) { btn.disabled = false; btn.textContent = 'Buy Label'; }
  }
}

async function printAndDropOff(orderId, labelUrl) {
  window.open(labelUrl, '_blank');
  try {
    const res = await fetch(API + '/orders/' + orderId + '/status', {
      method: 'PATCH', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ status: 'drop_off' }),
    });
    if (res.ok) {
      toast('Shipping label opened & order marked as Drop Off');
      await refreshProgress();
      // Auto-clear active order and move to next
      if (activeOrderId === orderId) {
        clearActiveOrder();
      }
    } else {
      const e = await res.json().catch(() => ({}));
      toast(e.detail || 'Error updating status', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// Delete batch from picking list selector
async function deleteBatch(plId, plNumber) {
  if (!confirm(`Delete batch "${plNumber}"?\nAll orders will be released from this batch.`)) return;
  try {
    const res = await fetch(API + '/picking-lists/' + plId, { method: 'DELETE' });
    if (res.ok) {
      const data = await res.json();
      toast(`Batch deleted: ${data.orders_released} orders released`);
      if (currentPL && currentPL.id === plId) {
        currentPL = null;
        stopAutoRefresh();
        document.getElementById('packing-session').style.display = 'none';
        document.getElementById('header-info').textContent = '';
      }
      await loadPickingLists();
    } else {
      const e = await res.json().catch(() => ({}));
      toast(e.detail || 'Error deleting batch', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// Unpack entire batch
async function unpackBatch() {
  if (!currentPL) return;
  if (!confirm(`Unpack entire batch "${currentPL.picking_number}"?\nThis will release all orders from this batch and delete the picking list.`)) return;
  try {
    const res = await fetch(API + '/picking-lists/' + currentPL.id, { method: 'DELETE' });
    if (res.ok) {
      const data = await res.json();
      toast(`Batch unpacked: ${data.orders_released} orders released, ${data.items_removed} items removed`);
      currentPL = null;
      stopAutoRefresh();
      document.getElementById('packing-session').style.display = 'none';
      document.getElementById('header-info').textContent = '';
      await loadPickingLists();
    } else {
      const e = await res.json().catch(() => ({}));
      toast(e.detail || 'Error unpacking batch', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// Unpack single order from batch
async function unpackOrder(orderId, orderNumber) {
  if (!currentPL) return;
  if (!confirm(`Remove order "${orderNumber}" from this batch?\nAll pick items for this order will be deleted.`)) return;
  try {
    const res = await fetch(API + '/picking-lists/' + currentPL.id + '/orders/' + orderId, { method: 'DELETE' });
    if (res.ok) {
      const data = await res.json();
      toast(`Order ${orderNumber} removed (${data.items_removed} items)`);
      if (data.picking_list_deleted) {
        toast('Picking list deleted (no more orders)');
        currentPL = null;
        stopAutoRefresh();
        document.getElementById('packing-session').style.display = 'none';
        document.getElementById('header-info').textContent = '';
        await loadPickingLists();
      } else {
        await refreshProgress();
      }
    } else {
      const e = await res.json().catch(() => ({}));
      toast(e.detail || 'Error removing order', 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// Auth
async function loadCurrentUser() {
  try {
    const res = await fetch('/api/v1/auth/me');
    if (res.ok) { const u = await res.json(); document.getElementById('current-user').textContent = u.display_name || u.username; }
  } catch {}
}
async function doLogout() {
  await fetch('/api/v1/auth/logout', { method: 'POST' });
  window.location.href = '/login';
}

// Init
loadCurrentUser();
loadPickingLists();

// Auto-select if URL has picking list ID
const pathParts = window.location.pathname.split('/');
if (pathParts.length >= 3 && pathParts[1] === 'packing' && pathParts[2]) {
  const plId = pathParts[2];
  fetch(API + '/picking-lists/' + plId).then(r => r.ok ? r.json() : null).then(pl => {
    if (pl) {
      currentPL = pl;
      document.getElementById('pl-number').textContent = pl.picking_number;
      document.getElementById('header-info').textContent = pl.picking_number;
      document.getElementById('packing-session').style.display = '';
      document.getElementById('scan-input').focus();
      refreshProgress();
      startAutoRefresh();
    }
  }).catch(() => {});
}
</script>
</body>
</html>
